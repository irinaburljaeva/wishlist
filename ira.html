<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–í–æ—Ç, —á—Ç–æ —Ö–æ—á–µ—Ç –ò—Ä–∞</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      min-height: 100vh;
      margin: 0;
      background: linear-gradient(180deg, #fffaf5 0%, #ffffff 40%);
      color: #0f172a;
    }

    .container-narrow {
      max-width: 980px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .card {
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(12px);
      border-radius: 28px;
      box-shadow:
        0 10px 30px rgba(15,23,42,.06),
        0 2px 8px rgba(15,23,42,.04);
      border: 1px solid rgba(255,180,90,.15);
      transition: all .25s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow:
        0 20px 50px rgba(15,23,42,.10),
        0 5px 20px rgba(15,23,42,.06);
    }

    .btn {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:999px;
      padding:12px 18px;
      font-size:14px;
      font-weight:600;
      transition: all .2s ease;
      cursor:pointer;
    }

    .btn-primary {
      background: linear-gradient(135deg,#fb923c,#facc15);
      color:#111827;
      box-shadow: 0 6px 20px rgba(251,146,60,.35);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 30px rgba(251,146,60,.45);
    }

    .btn-primary:active { transform: scale(.97); }
    .btn-primary:disabled { opacity:.5; cursor:not-allowed; box-shadow:none; }

    .btn-ghost {
      background:transparent;
      color:#0f172a;
      border:1px solid rgba(15,23,42,.15);
    }

    .btn-ghost:hover { background:rgba(15,23,42,.05); }

    .input,.textarea {
      width:100%;
      border-radius:18px;
      border:1px solid rgba(15,23,42,.12);
      padding:12px 16px;
      outline:none;
      background:#ffffff;
      transition: all .2s ease;
      font-size:14px;
    }

    .input:focus,.textarea:focus {
      border-color:#fb923c;
      box-shadow:0 0 0 4px rgba(251,146,60,.18);
    }

    .badge {
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius:999px;
      background:linear-gradient(135deg,#fff7ed,#fef3c7);
      color:#92400e;
      font-size:11px;
      padding:6px 10px;
      font-weight:600;
    }

    .badge-soft {
      background:#f1f5f9;
      color:#334155;
    }

    .err { color:#b91c1c; font-size:13px; }
    .note { color:#64748b; font-size:13px; }

    .progress-wrapper {
      width:100%;
      height:10px;
      background:#f1f5f9;
      border-radius:999px;
      overflow:hidden;
    }

    .progress-bar {
      height:100%;
      background:linear-gradient(90deg,#fb923c,#facc15);
      transition: width .6s ease;
    }

    .modal-overlay {
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.65);
      backdrop-filter: blur(6px);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:50;
    }

    .modal-box {
      background:#ffffff;
      border-radius:32px;
      padding:32px;
      width:360px;
      box-shadow:0 20px 60px rgba(15,23,42,.25);
    }
  </style>
</head>
<body>

  <section class="container-narrow pt-14 pb-10 text-center">
    <div class="space-y-4">
      <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-amber-100 text-amber-900 text-xs font-semibold">
        üíõ –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è –ò—Ä—ã
      </div>
      <h1 class="text-4xl font-bold tracking-tight">
        –í–æ—Ç, —á—Ç–æ —Ö–æ—á–µ—Ç –ò—Ä–∞
      </h1>
      <p class="text-slate-600 max-w-xl mx-auto">
        –ó–¥–µ—Å—å —Å–æ–±—Ä–∞–Ω—ã –∏–¥–µ–∏ –ø–æ–¥–∞—Ä–∫–æ–≤ –∏ –±–æ–ª—å—à–∏–µ –º–µ—á—Ç—ã.
        –ú–æ–∂–Ω–æ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–∞—Ä–æ–∫ –∏–ª–∏ –≤–ª–æ–∂–∏—Ç—å—Å—è –≤ –º–µ—á—Ç—É ‚ú®
      </p>
    </div>
  </section>

  <main id="root" class="pb-20"></main>

<script type="text/babel">

const { useEffect, useState } = React;

/* FIREBASE */

const firebaseConfig = {
  apiKey: "AIzaSyC26Xjjr0pFQDVFtCgRyteEpNEjngVOJFI",
  authDomain: "wishlist-37819.firebaseapp.com",
  projectId: "wishlist-37819",
  storageBucket: "wishlist-37819.firebasestorage.app",
  messagingSenderId: "72495355387",
  appId: "1:72495355387:web:0ff709125d3cf33c8c275e"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
auth.signInAnonymously().catch(console.error);

const LIST_ID = 'newyear2025';
const listDoc  = db.collection('lists').doc(LIST_ID);
const itemsCol = () => listDoc.collection('items');
const claimsCol = () => listDoc.collection('claims');
const dreamsCol = () => listDoc.collection('dreams');

const normalize = s => (s||'').trim().toLowerCase();
const IRA_KEY = '–∏—Ä–∞';

/* CERTIFICATE */

function openCertificate(dream, amount, name){
  const w = window.open('','_blank');
  w.document.write(`
  <html><head><title>–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç</title></head>
  <body style="font-family:sans-serif;background:#fffaf0;display:flex;align-items:center;justify-content:center;height:100vh;">
  <div style="border:4px solid #fb923c;border-radius:40px;padding:60px;text-align:center;background:white;width:700px;">
  <h1>–°–ï–†–¢–ò–§–ò–ö–ê–¢</h1>
  <p>${name} –≤–Ω—ë—Å(–ª–∞)</p>
  <div style="font-size:32px;margin:20px 0;font-weight:600;">${Number(amount).toLocaleString()} ‚ÇΩ</div>
  <p>–≤ –º–µ—á—Ç—É –ò—Ä—ã:</p>
  <h2>${dream.title}</h2>
  <p>${new Date().toLocaleDateString()}</p>
  </div>
  <script>window.print()<\/script>
  </body></html>`);
}

/* DREAM CARD GUEST */

function DreamCardGuest({dream,currentUserName}){

  const [contributions,setContributions] = useState([]);
  const [show,setShow] = useState(false);
  const [amount,setAmount] = useState('');

  useEffect(()=>{
    const unsub = dreamsCol().doc(dream.id)
      .collection('contributions')
      .onSnapshot(s=>{
        const arr=[];
        s.forEach(d=>arr.push(d.data()));
        setContributions(arr);
      });
    return ()=>unsub();
  },[dream.id]);

  const total = contributions.reduce((s,c)=>s+(Number(c.amount)||0),0);
  const percent = dream.targetAmount
    ? Math.min(100,Math.round((total/dream.targetAmount)*100))
    : 0;

  const handle = async()=>{
    if(!amount) return;
    await dreamsCol().doc(dream.id)
      .collection('contributions')
      .add({
        contributorName:currentUserName,
        amount:Number(amount),
        createdAt:Date.now()
      });
    openCertificate(dream,amount,currentUserName);
    setAmount('');
    setShow(false);
  };

  return(
    <div className="card p-6 space-y-4">
      <div>
        <div className="text-lg font-semibold">{dream.title}</div>
        <div className="text-sm text-slate-600">{dream.description}</div>
      </div>

      {dream.targetAmount>0 && <>
        <div className="progress-wrapper">
          <div className="progress-bar" style={{width:percent+'%'}}/>
        </div>
        <div className="text-xs text-slate-600">
          –°–æ–±—Ä–∞–Ω–æ {total.toLocaleString()} ‚ÇΩ –∏–∑ {dream.targetAmount.toLocaleString()} ‚ÇΩ
        </div>
      </>}

      <button className="btn btn-primary w-full" onClick={()=>setShow(true)}>
        üíõ –í–ª–æ–∂–∏—Ç—å—Å—è
      </button>

      {show && (
        <div className="modal-overlay">
          <div className="modal-box space-y-4">
            <input className="input"
              placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É"
              value={amount}
              onChange={e=>setAmount(e.target.value)}/>
            <button className="btn btn-primary w-full" onClick={handle}>
              –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
            </button>
            <button className="btn btn-ghost w-full" onClick={()=>setShow(false)}>
              –û—Ç–º–µ–Ω–∞
            </button>
          </div>
        </div>
      )}
    </div>
  );
}

/* APP */

function App(){

  const [userName,setUserName] = useState('');
  const [dreams,setDreams] = useState([]);

  useEffect(()=>{
    const unsub = dreamsCol().orderBy('createdAt','desc')
      .onSnapshot(s=>{
        const arr=[];
        s.forEach(d=>arr.push({id:d.id,...d.data()}));
        setDreams(arr);
      });
    return ()=>unsub();
  },[]);

  const trimmed = userName.trim();
  const isAdmin = normalize(trimmed).startsWith(IRA_KEY);

  return(
    <div className="container-narrow space-y-8">
      <div className="card p-6 space-y-3">
        <input
          className="input"
          value={userName}
          onChange={e=>setUserName(e.target.value)}
          placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è"/>
      </div>

      {trimmed && !isAdmin && (
        <div className="grid gap-4 md:grid-cols-2">
          {dreams.map(d=>(
            <DreamCardGuest
              key={d.id}
              dream={d}
              currentUserName={trimmed}/>
          ))}
        </div>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);

</script>
</body>
</html>

