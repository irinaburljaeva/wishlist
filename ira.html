<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ü–æ–¥–∞—Ä–∫–∏ –¥–ª—è –ò—Ä–∏–Ω—ã ‚Äî —Å–µ–º–µ–π–Ω—ã–π –≤–∏—à-–ª–∏—Å—Ç</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      min-height: 100vh;
      margin: 0;
    }

    .container-narrow { max-width: 960px; margin: 0 auto; padding: 0 16px; }

    .card {
      background:#ffffff;
      border-radius:24px;
      box-shadow:0 20px 40px rgba(15,23,42,.10);
      border:1px solid rgba(148,163,184,.25);
    }

    .btn {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:999px;
      padding:10px 16px;
      font-size:14px;
      font-weight:600;
    }
    .btn-primary {
      background:linear-gradient(135deg,#f97316,#facc15);
      color:#111827;
    }
    .btn-primary:disabled { opacity:.6; cursor:not-allowed; }
    .btn-ghost { background:transparent; color:#0f172a; }

    .input, .textarea {
      width:100%;
      border-radius:16px;
      border:1px solid #e2e8f0;
      padding:10px 14px;
      outline:none;
      background:#f8fafc;
    }
    .input:focus, .textarea:focus {
      border-color:#fb923c;
      box-shadow:0 0 0 3px rgba(251,146,60,.25);
      background:#ffffff;
    }

    .badge {
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius:999px;
      background:#fefce8;
      color:#92400e;
      font-size:11px;
      padding:4px 9px;
    }
    .badge-soft {
      background:#e2e8f0;
      color:#334155;
    }
    .err { color:#b91c1c; font-size:13px; }
    .note { color:#64748b; font-size:13px; }
  </style>
</head>
<body>
  <!-- –§–æ–Ω -->
  <img
    src="D1EA6935-8F4B-495D-8B1F-C5BEE102DFE8.png"
    alt=""
    class="fixed inset-0 w-full h-full object-cover -z-20"
  />
  <div class="fixed inset-0 bg-white/50 backdrop-blur-md -z-10"></div>

  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useState, useMemo } = React;

    // === Firebase init ===
    const firebaseConfig = {
      apiKey: "AIzaSyC26Xjjr0pFQDVFtCgRyteEpNEjngVOJFI",
      authDomain: "wishlist-37819.firebaseapp.com",
      projectId: "wishlist-37819",
      storageBucket: "wishlist-37819.firebasestorage.app",
      messagingSenderId: "72495355387",
      appId: "1:72495355387:web:0ff709125d3cf33c8c275e"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();
    auth.signInAnonymously().catch(console.error);

    const LIST_ID = 'newyear2025';
    const listDoc  = db.collection('lists').doc(LIST_ID);
    const itemsCol  = () => listDoc.collection('items');
    const claimsCol = () => listDoc.collection('claims');
    const dreamsCol = () => listDoc.collection('dreams'); // üí≠ –±–æ–ª—å—à–∏–µ –º–µ—á—Ç—ã

    const saveLocal = (k,v) => localStorage.setItem(k, JSON.stringify(v));
    const loadLocal = (k,fallback) => {
      try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : fallback; }
      catch { return fallback; }
    };

    const normalize = (s) => (s || '').trim().toLowerCase();
    const IRA_KEY = '–∏—Ä–∞';

    // –°–∂–∞—Ç–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–¥–ª—è —Ñ–æ—Ç–æ –∏ QR)
    async function compressImage(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => {
          const img = new Image();
          img.onload = () => {
            const MAX_WIDTH = 800;
            const MAX_HEIGHT = 800;
            const scale = Math.min(
              MAX_WIDTH / img.width,
              MAX_HEIGHT / img.height,
              1
            );

            const canvas = document.createElement('canvas');
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            const dataUrl = canvas.toDataURL('image/jpeg', 0.7);

            if (dataUrl.length > 900000) {
              reject('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ –¥–∞–∂–µ –ø–æ—Å–ª–µ —Å–∂–∞—Ç–∏—è. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –ø–æ–º–µ–Ω—å—à–µ.');
              return;
            }

            resolve(dataUrl);
          };
          img.onerror = () => reject('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.');
          img.src = e.target.result;
        };
        reader.onerror = () => reject('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª.');
        reader.readAsDataURL(file);
      });
    }

    function Header() {
      return (
        <header className="container-narrow pt-6 pb-3">
          <div className="flex items-center gap-4">
            <div className="w-11 h-11 rounded-2xl bg-gradient-to-tr from-rose-500 to-amber-300 flex items-center justify-center text-2xl shadow-lg">
              üéÑ
            </div>
            <div>
              <h1 className="text-2xl font-bold text-slate-900">
                –ü–æ–¥–∞—Ä–∫–∏ –¥–ª—è –ò—Ä–∏–Ω—ã
              </h1>
              <p className="text-sm text-slate-600">
                –ó–¥–µ—Å—å —Å–æ–±—Ä–∞–Ω—ã –∏–¥–µ–∏ –ø–æ–¥–∞—Ä–∫–æ–≤ –∏ –±–æ–ª—å—à–∏–µ –º–µ—á—Ç—ã –ò—Ä—ã –Ω–∞ –ù–æ–≤—ã–π –≥–æ–¥.
              </p>
            </div>
          </div>
        </header>
      );
    }

    function WhoAreYouCard({ userName, setUserName }) {
      const [temp, setTemp] = useState(userName || '');

      return (
        <section className="container-narrow mb-4">
          <div className="card px-5 py-4 flex items-start gap-4">
            <div className="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center text-xl">
              üëã
            </div>
            <div className="flex-1 space-y-2">
              <div className="text-sm font-semibold text-slate-800">
                –î–∞–≤–∞–π—Ç–µ –ø–æ–∑–Ω–∞–∫–æ–º–∏–º—Å—è
              </div>
              <p className="note">
                –ù–∞–ø–∏—à–∏—Ç–µ, –∫–∞–∫ –∫ –≤–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è. –ï—Å–ª–∏ –≤—ã –ò—Ä–∞ ‚Äî –≤—ã —Å–º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Å–ø–∏—Å–æ–∫
                –∏ –¥–æ–±–∞–≤–ª—è—Ç—å –±–æ–ª—å—à–∏–µ –º–µ—á—Ç—ã. –ï—Å–ª–∏ –≤—ã –≥–æ—Å—Ç—å ‚Äî –≤—ã —Å–º–æ–∂–µ—Ç–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–∞—Ä–æ–∫
                –∏–ª–∏ –≤–ª–æ–∂–∏—Ç—å—Å—è –≤ –º–µ—á—Ç—É.
              </p>
              <div className="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center">
                <input
                  className="input text-sm"
                  placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò—Ä–∞, –ê–Ω—Ç–æ–Ω, –ú–∞–º–∞‚Ä¶"
                  value={temp}
                  onChange={e => setTemp(e.target.value)}
                />
                <button
                  className="btn btn-primary text-sm sm:w-auto w-full"
                  onClick={() => setUserName(temp.trim())}
                  disabled={!temp.trim()}
                >
                  –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
                </button>
              </div>
            </div>
          </div>
        </section>
      );
    }

    // ----- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–¥–∞—Ä–∫–∞ (–ò—Ä–∞) -----
    function AddWishFormIra({ onAdd, disabled, error }) {
      const [title,setTitle] = useState('');
      const [url,setUrl] = useState('');
      const [note,setNote] = useState('');
      const [imageData,setImageData] = useState('');
      const [imageError,setImageError] = useState('');
      const [imageLoading,setImageLoading] = useState(false);

      const submit = () => {
        if (disabled) return;
        if (!title.trim()) return;
        onAdd({ title:title.trim(), url:url.trim(), note:note.trim(), image:imageData });
        setTitle(''); setUrl(''); setNote(''); setImageData(''); setImageError('');
      };

      const handleFileChange = async (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) {
          setImageData('');
          setImageError('');
          return;
        }
        setImageLoading(true);
        setImageError('');
        try {
          const compressed = await compressImage(file);
          setImageData(compressed);
        } catch (err) {
          console.error(err);
          setImageData('');
          setImageError(typeof err === 'string'
            ? err
            : '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª.');
        } finally {
          setImageLoading(false);
        }
      };

      return (
        <div className="card p-4 mb-4">
          <div className="flex items-center justify-between mb-2">
            <h2 className="font-semibold text-slate-900 text-base">–î–æ–±–∞–≤–∏—Ç—å –∏–¥–µ—é –ø–æ–¥–∞—Ä–∫–∞</h2>
            <span className="badge text-[11px]">–°–ø–∏—Å–æ–∫ –¥–ª—è –ò—Ä—ã</span>
          </div>
          <div className="space-y-3">
            <input
              className="input text-sm"
              placeholder="–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å? (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç—ë–ø–ª—ã–π –ø–ª–µ–¥)"
              value={title}
              onChange={e=>setTitle(e.target.value)}
            />

            <input
              className="input text-sm"
              placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä (–º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å, —Å–∞–π—Ç‚Ä¶)"
              value={url}
              onChange={e=>setUrl(e.target.value)}
            />

            <textarea
              className="textarea text-sm resize-none"
              rows="2"
              placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: —Ü–≤–µ—Ç, —Ä–∞–∑–º–µ—Ä, –Ω—é–∞–Ω—Å—ã‚Ä¶"
              value={note}
              onChange={e=>setNote(e.target.value)}
            ></textarea>

            <div className="space-y-2">
              <label className="text-sm font-medium text-slate-800">
                –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
              </label>
              <input
                type="file"
                accept="image/*"
                className="input text-sm"
                onChange={handleFileChange}
              />
              {imageLoading && <div className="note">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∂–∏–º–∞–µ—Ç—Å—è‚Ä¶</div>}
              {imageError && <div className="err">{imageError}</div>}
              {imageData && !imageLoading && (
                <img
                  src={imageData}
                  alt="–ü—Ä–µ–≤—å—é –ø–æ–¥–∞—Ä–∫–∞"
                  className="rounded-2xl mt-2 max-h-40 object-cover w-full"
                />
              )}
            </div>

            {error && <div className="err">{error}</div>}
            <div className="flex justify-end">
              <button className="btn btn-primary text-sm" onClick={submit} disabled={disabled}>
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫
              </button>
            </div>
          </div>
        </div>
      );
    }

    // ----- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–æ–ª—å—à–æ–π –º–µ—á—Ç—ã (–ò—Ä–∞) -----
    function AddDreamFormIra({ onAdd, disabled, error }) {
      const [title,setTitle] = useState('');
      const [desc,setDesc] = useState('');
      const [link,setLink] = useState('');
      const [qrImage,setQrImage] = useState('');
      const [imgError,setImgError] = useState('');
      const [imgLoading,setImgLoading] = useState(false);

      const submit = () => {
        if (disabled) return;
        if (!title.trim()) return;
        onAdd({
          title: title.trim(),
          description: desc.trim(),
          link: link.trim(),
          qrImage: qrImage || null
        });
        setTitle(''); setDesc(''); setLink(''); setQrImage(''); setImgError('');
      };

      const handleQrChange = async (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) {
          setQrImage('');
          setImgError('');
          return;
        }
        setImgLoading(true);
        setImgError('');
        try {
          const compressed = await compressImage(file);
          setQrImage(compressed);
        } catch (err) {
          console.error(err);
          setQrImage('');
          setImgError(typeof err === 'string'
            ? err
            : '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª.');
        } finally {
          setImgLoading(false);
        }
      };

      return (
        <div className="card p-4 mb-4">
          <div className="flex items-center justify-between mb-2">
            <h2 className="font-semibold text-slate-900 text-base">–î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à—É—é –º–µ—á—Ç—É</h2>
            <span className="badge text-[11px]">–°–±–æ—Ä –Ω–∞ –ø–æ–¥–∞—Ä–æ–∫</span>
          </div>
          <div className="space-y-3">
            <input
              className="input text-sm"
              placeholder="–û —á—ë–º –º–µ—á—Ç–∞–µ—Ç–µ? (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç–∏–≤, –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ‚Ä¶) "
              value={title}
              onChange={e=>setTitle(e.target.value)}
            />

            <textarea
              className="textarea text-sm resize-none"
              rows="2"
              placeholder="–ö–æ—Ä–æ—Ç–∫–æ –æ–ø–∏—à–∏—Ç–µ –º–µ—á—Ç—É: –∑–∞—á–µ–º, –ø–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ‚Ä¶"
              value={desc}
              onChange={e=>setDesc(e.target.value)}
            ></textarea>

            <input
              className="input text-sm"
              placeholder="–°—Å—ã–ª–∫–∞ —Å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—è–º–∏ (–Ω–∞ —Å–∞–π—Ç, –Ω–∞ —Å–ø–∏—Å–æ–∫, –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
              value={link}
              onChange={e=>setLink(e.target.value)}
            />

            <div className="space-y-2">
              <label className="text-sm font-medium text-slate-800">
                QR-–∫–æ–¥ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ (–°–ë–ü, –∫–∞—Ä—Ç–∞ –∏ —Ç.–ø., –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
              </label>
              <input
                type="file"
                accept="image/*"
                className="input text-sm"
                onChange={handleQrChange}
              />
              {imgLoading && <div className="note">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∂–∏–º–∞–µ—Ç—Å—è‚Ä¶</div>}
              {imgError && <div className="err">{imgError}</div>}
              {qrImage && !imgLoading && (
                <img
                  src={qrImage}
                  alt="QR-–∫–æ–¥"
                  className="rounded-2xl mt-2 max-h-40 object-contain w-full bg-white"
                />
              )}
            </div>

            {error && <div className="err">{error}</div>}
            <div className="flex justify-end">
              <button className="btn btn-primary text-sm" onClick={submit} disabled={disabled}>
                ‚ú® –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à—É—é –º–µ—á—Ç—É
              </button>
            </div>
          </div>
        </div>
      );
    }

    // ----- –ö–∞—Ä—Ç–æ—á–∫–∏ –ò—Ä—ã: –æ–±—ã—á–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏ -----
    function WishCardIra({ wish, onDelete, onUpdate, onImageClick }) {
      const [editing, setEditing] = useState(false);
      const [title, setTitle] = useState(wish.title || '');
      const [url, setUrl] = useState(wish.url || '');
      const [note, setNote] = useState(wish.note || '');
      const [imageData, setImageData] = useState(wish.image || '');
      const [imageError,setImageError] = useState('');
      const [imageLoading,setImageLoading] = useState(false);

      useEffect(() => {
        setTitle(wish.title || '');
        setUrl(wish.url || '');
        setNote(wish.note || '');
        setImageData(wish.image || '');
        setImageError('');
        setImageLoading(false);
        setEditing(false);
      }, [wish.id]);

      const handleSave = async () => {
        if (!title.trim()) return;
        await onUpdate(wish.id, {
          title: title.trim(),
          url: url.trim(),
          note: note.trim(),
          image: imageData || null
        });
        setEditing(false);
      };

      const handleDeleteClick = async () => {
        if (!window.confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—É–Ω–∫—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ –ø–æ–¥–∞—Ä–∫–æ–≤?')) return;
        await onDelete(wish.id);
      };

      const handleFileChange = async (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) {
          setImageData(wish.image || '');
          setImageError('');
          return;
        }
        setImageLoading(true);
        setImageError('');
        try {
          const compressed = await compressImage(file);
          setImageData(compressed);
        } catch (err) {
          console.error(err);
          setImageError(typeof err === 'string'
            ? err
            : '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª.');
        } finally {
          setImageLoading(false);
        }
      };

      if (editing) {
        return (
          <div className="card p-3 space-y-2">
            <div className="text-xs uppercase text-slate-400 tracking-wide mb-1">
              –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—É–Ω–∫—Ç–∞
            </div>
            <input
              className="input text-sm mb-2"
              value={title}
              onChange={e=>setTitle(e.target.value)}
              placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∞"
            />
            <input
              className="input text-sm mb-2"
              value={url}
              onChange={e=>setUrl(e.target.value)}
              placeholder="–°—Å—ã–ª–∫–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
            />
            <textarea
              className="textarea text-sm mb-2"
              rows="2"
              value={note}
              onChange={e=>setNote(e.target.value)}
              placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"
            />
            <div className="space-y-2 mb-2">
              <label className="text-xs font-medium text-slate-700">
                –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
              </label>
              <input
                type="file"
                accept="image/*"
                className="input text-sm"
                onChange={handleFileChange}
              />
            {imageLoading && <div className="note">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∂–∏–º–∞–µ—Ç—Å—è‚Ä¶</div>}
            {imageError && <div className="err">{imageError}</div>}
            {imageData && !imageLoading && (
              <img
                src={imageData}
                alt=""
                className="w-full rounded-xl object-cover max-h-40 cursor-pointer"
                onClick={() => onImageClick(imageData)}
              />
            )}
            </div>
            <div className="flex gap-2 justify-end border-t border-slate-100 pt-2">
              <button
                className="btn btn-ghost text-xs border border-slate-300"
                onClick={() => setEditing(false)}
              >
                –û—Ç–º–µ–Ω–∞
              </button>
              <button
                className="btn btn-primary text-xs"
                onClick={handleSave}
              >
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
              </button>
            </div>
          </div>
        );
      }

      return (
        <div className="card p-3 flex flex-col gap-3">
          {wish.image && (
            <img
              src={wish.image}
              alt=""
              className="w-full rounded-xl object-cover max-h-48 cursor-pointer"
              onClick={() => onImageClick(wish.image)}
            />
          )}
          <div className="flex justify-between items-start gap-3">
            <div>
              <div className="font-semibold text-sm text-slate-900">{wish.title}</div>
              {wish.note && <div className="text-xs text-slate-600 mt-1">{wish.note}</div>}
              {wish.url && (
                <a
                  href={wish.url}
                  target="_blank"
                  rel="noreferrer"
                  className="text-xs text-sky-700 underline mt-1 inline-block"
                >
                  –û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É
                </a>
              )}
            </div>
            <span className="badge-soft badge text-[11px]">–í —Å–ø–∏—Å–∫–µ –ò—Ä—ã</span>
          </div>
          <div className="flex gap-1 justify-end border-t border-slate-100 pt-2">
            <button
              className="btn btn-ghost border border-slate-300 text-xs px-3 py-1"
              onClick={() => setEditing(true)}
            >
              –ò–∑–º–µ–Ω–∏—Ç—å
            </button>
            <button
              className="btn btn-ghost border border-red-200 text-xs px-3 py-1 text-red-600"
              onClick={handleDeleteClick}
            >
              –£–¥–∞–ª–∏—Ç—å
            </button>
          </div>
        </div>
      );
    }

    // ----- –ö–∞—Ä—Ç–æ—á–∫–∞ –±–æ–ª—å—à–æ–π –º–µ—á—Ç—ã –¥–ª—è –ò—Ä—ã -----
    function DreamCardIra({ dream, onDelete, onUpdate, onImageClick }) {
      const [editing,setEditing] = useState(false);
      const [title,setTitle] = useState(dream.title || '');
      const [desc,setDesc]   = useState(dream.description || '');
      const [link,setLink]   = useState(dream.link || '');
      const [qrImage,setQrImage] = useState(dream.qrImage || '');
      const [imgError,setImgError] = useState('');
      const [imgLoading,setImgLoading] = useState(false);

      useEffect(() => {
        setTitle(dream.title || '');
        setDesc(dream.description || '');
        setLink(dream.link || '');
        setQrImage(dream.qrImage || '');
        setImgError('');
        setImgLoading(false);
        setEditing(false);
      }, [dream.id]);

      const handleSave = async () => {
        if (!title.trim()) return;
        await onUpdate(dream.id, {
          title: title.trim(),
          description: desc.trim(),
          link: link.trim(),
          qrImage: qrImage || null
        });
        setEditing(false);
      };

      const handleDelete = async () => {
        if (!window.confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –º–µ—á—Ç—É –∏–∑ —Å–ø–∏—Å–∫–∞?')) return;
        await onDelete(dream.id);
      };

      const handleQrChange = async (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) {
          setQrImage(dream.qrImage || '');
          setImgError('');
          return;
        }
        setImgLoading(true);
        setImgError('');
        try {
          const compressed = await compressImage(file);
          setQrImage(compressed);
        } catch (err) {
          console.error(err);
          setImgError(typeof err === 'string'
            ? err
            : '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª.');
        } finally {
          setImgLoading(false);
        }
      };

      if (editing) {
        return (
          <div className="card p-3 space-y-2">
            <div className="text-xs uppercase text-slate-400 tracking-wide mb-1">
              –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—á—Ç—ã
            </div>
            <input
              className="input text-sm mb-2"
              value={title}
              onChange={e=>setTitle(e.target.value)}
              placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—á—Ç—ã"
            />
            <textarea
              className="textarea text-sm mb-2"
              rows="2"
              value={desc}
              onChange={e=>setDesc(e.target.value)}
              placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"
            />
            <input
              className="input text-sm mb-2"
              value={link}
              onChange={e=>setLink(e.target.value)}
              placeholder="–°—Å—ã–ª–∫–∞ —Å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—è–º–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
            />
            <div className="space-y-2 mb-2">
              <label className="text-xs font-medium text-slate-700">
                QR-–∫–æ–¥ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
              </label>
              <input
                type="file"
                accept="image/*"
                className="input text-sm"
                onChange={handleQrChange}
              />
              {imgLoading && <div className="note">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∂–∏–º–∞–µ—Ç—Å—è‚Ä¶</div>}
              {imgError && <div className="err">{imgError}</div>}
              {qrImage && !imgLoading && (
                <img
                  src={qrImage}
                  alt="QR-–∫–æ–¥"
                  className="w-full rounded-xl object-contain max-h-40 cursor-pointer bg-white"
                  onClick={() => onImageClick(qrImage)}
                />
              )}
            </div>
            <div className="flex gap-2 justify-end border-t border-slate-100 pt-2">
              <button
                className="btn btn-ghost text-xs border border-slate-300"
                onClick={() => setEditing(false)}
              >
                –û—Ç–º–µ–Ω–∞
              </button>
              <button
                className="btn btn-primary text-xs"
                onClick={handleSave}
              >
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
              </button>
            </div>
          </div>
        );
      }

      return (
        <div className="card p-3 flex flex-col gap-3">
          <div className="flex justify-between items-start gap-3">
            <div>
              <div className="font-semibold text-sm text-slate-900">{dream.title}</div>
              {dream.description && (
                <div className="text-xs text-slate-600 mt-1">{dream.description}</div>
              )}
              {dream.link && (
                <a
                  href={dream.link}
                  target="_blank"
                  rel="noreferrer"
                  className="text-xs text-sky-700 underline mt-1 inline-block"
                >
                  –ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ –º–µ—á—Ç–µ
                </a>
              )}
            </div>
            <span className="badge-soft badge text-[11px]">–ë–æ–ª—å—à–∞—è –º–µ—á—Ç–∞</span>
          </div>

          {dream.qrImage && (
            <div className="bg-slate-50 rounded-2xl p-2 flex flex-col items-center gap-1">
              <div className="text-[11px] text-slate-500 mb-1">
                –≠—Ç–æ—Ç QR-–∫–æ–¥ —É–≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Ç–µ, –∫–æ–º—É –≤—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É.
              </div>
              <img
                src={dream.qrImage}
                alt="QR-–∫–æ–¥"
                className="w-40 h-40 object-contain cursor-pointer bg-white rounded-xl"
                onClick={() => onImageClick(dream.qrImage)}
              />
            </div>
          )}

          <div className="flex gap-1 justify-end border-t border-slate-100 pt-2">
            <button
              className="btn btn-ghost border border-slate-300 text-xs px-3 py-1"
              onClick={() => setEditing(true)}
            >
              –ò–∑–º–µ–Ω–∏—Ç—å
            </button>
            <button
              className="btn btn-ghost border border-red-200 text-xs px-3 py-1 text-red-600"
              onClick={handleDelete}
            >
              –£–¥–∞–ª–∏—Ç—å
            </button>
          </div>
        </div>
      );
    }

    // ----- –ö–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –≥–æ—Å—Ç–µ–π: –æ–±—ã—á–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏ -----
    function WishCardGuest({ wish, claim, currentUserName, onClaim, onUnclaim, onImageClick }) {
      const claimed = !!claim;
      const iGift = claim && normalize(claim.claimerName) === normalize(currentUserName);
      const [showInfo, setShowInfo] = React.useState(false);

      const handleDisabledClick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        setShowInfo((v) => !v);
      };

      return (
        <div className="card p-3">
          <div className="flex flex-col gap-2">
            {wish.image && (
              <img
                src={wish.image}
                alt=""
                className="w-full rounded-xl object-cover max-h-48 cursor-pointer"
                onClick={() => onImageClick(wish.image)}
              />
            )}

            <div className="flex items-start gap-3">
              <div className="flex-1 space-y-1">
                <div className="font-semibold text-sm text-slate-900">
                  {wish.title}
                </div>

                {wish.note && (
                  <div className="text-xs text-slate-600">
                    {wish.note}
                  </div>
                )}

                {wish.url && (
                  <a
                    href={wish.url}
                    target="_blank"
                    rel="noreferrer"
                    className="text-xs text-sky-700 underline inline-block"
                  >
                    –û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É
                  </a>
                )}
              </div>

              <div className="min-w-[150px] text-right space-y-2 relative">
                {claimed ? (
                  iGift ? (
                    <div className="flex flex-col items-end gap-2">
                      <span className="text-xs px-2 py-1 rounded-lg bg-amber-100 text-amber-900 whitespace-nowrap">
                        üéÅ –í—ã –¥–∞—Ä–∏—Ç–µ —ç—Ç–æ—Ç –ø–æ–¥–∞—Ä–æ–∫
                      </span>
                      <button
                        className="btn text-xs w-full bg-white border border-slate-300 text-slate-700 hover:bg-slate-50"
                        onClick={onUnclaim}
                      >
                        –°–Ω—è—Ç—å –±—Ä–æ–Ω—å
                      </button>
                    </div>
                  ) : (
                    <>
                      <button
                        className="btn text-xs w-full md:w-[130px] bg-slate-200 text-slate-500 cursor-not-allowed"
                        disabled
                        onClick={handleDisabledClick}
                        onMouseEnter={() => setShowInfo(true)}
                        onMouseLeave={() => setShowInfo(false)}
                      >
                        –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ
                      </button>

                      {showInfo && (
                        <div className="absolute right-0 -top-9 bg-slate-900 text-[11px] text-white px-2 py-1 rounded-lg shadow-lg whitespace-nowrap z-10">
                          üéÅ –£–∂–µ –¥–∞—Ä–∏—Ç: {claim.claimerName}
                        </div>
                      )}
                    </>
                  )
                ) : (
                  <button
                    className="btn btn-primary text-xs w-full md:w-[130px] transition-transform duration-150 active:scale-95"
                    onClick={onClaim}
                  >
                    –Ø –ø–æ–¥–∞—Ä—é
                  </button>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    }

    // ----- –ö–∞—Ä—Ç–æ—á–∫–∏ –±–æ–ª—å—à–∏—Ö –º–µ—á—Ç –¥–ª—è –≥–æ—Å—Ç–µ–π -----
    function DreamCardGuest({ dream, onImageClick }) {
      return (
        <div className="card p-3 flex flex-col gap-3">
          <div>
            <div className="font-semibold text-sm text-slate-900">
              {dream.title}
            </div>
            {dream.description && (
              <div className="text-xs text-slate-600 mt-1">
                {dream.description}
              </div>
            )}
            {dream.link && (
              <a
                href={dream.link}
                target="_blank"
                rel="noreferrer"
                className="text-xs text-sky-700 underline mt-1 inline-block"
              >
                –ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ –º–µ—á—Ç–µ
              </a>
            )}
          </div>

          {dream.qrImage && (
            <div className="bg-slate-50 rounded-2xl p-3 flex flex-col items-center gap-2">
              <div className="text-[11px] text-slate-500 text-center">
                –•–æ—Ç–∏—Ç–µ –≤–ª–æ–∂–∏—Ç—å—Å—è –≤ —ç—Ç—É –º–µ—á—Ç—É? –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –∫–∞–º–µ—Ä–æ–π –±–∞–Ω–∫–∞
                –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É.
              </div>
              <img
                src={dream.qrImage}
                alt="QR-–∫–æ–¥ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞"
                className="w-40 h-40 object-contain cursor-pointer bg-white rounded-xl"
                onClick={() => onImageClick(dream.qrImage)}
              />
            </div>
          )}

          {!dream.qrImage && (
            <div className="note text-[11px]">
              –î–ª—è —ç—Ç–æ–π –º–µ—á—Ç—ã –ø–æ–∫–∞ –Ω–µ—Ç QR-–∫–æ–¥–∞. –°–ø—Ä–æ—Å–∏—Ç–µ —É –ò—Ä—ã, –∫–∞–∫ –ª—É—á—à–µ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –¥–µ–Ω—å–≥–∏ üòä
            </div>
          )}
        </div>
      );
    }

    // ---------- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ----------
    function App() {
      const [authUid,setAuthUid] = useState(null);
      const [userName,setUserName] = useState(loadLocal('ira:name',''));
      const [items,setItems] = useState([]);
      const [claims,setClaims] = useState({});
      const [dreams,setDreams] = useState([]);
      const [itemsLoading,setItemsLoading] = useState(true);
      const [dreamsLoading,setDreamsLoading] = useState(true);
      const [addError,setAddError] = useState('');
      const [dreamError,setDreamError] = useState('');
      const [claimError,setClaimError] = useState('');
      const [previewImage, setPreviewImage] = useState(null);

      useEffect(() => {
        const unsub = auth.onAuthStateChanged(u => setAuthUid(u?.uid || null));
        return () => unsub();
      }, []);

      useEffect(()=>{ saveLocal('ira:name', userName); }, [userName]);

      // –û–±—ã—á–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏
      useEffect(() => {
        setItemsLoading(true);
        const unsub = itemsCol().orderBy('createdAt','desc')
          .onSnapshot(
            snap => {
              const arr = [];
              snap.forEach(doc => arr.push({ id: doc.id, ...doc.data() }));
              setItems(arr);
              setItemsLoading(false);
            },
            err => { console.error(err); setItemsLoading(false); }
          );
        return () => unsub();
      }, []);

      // –ë—Ä–æ–Ω–∏
      useEffect(() => {
        const unsub = claimsCol().onSnapshot(
          snap => {
            const map = {};
            snap.forEach(doc => map[doc.id] = doc.data());
            setClaims(map);
          },
          err => {
            console.error('claims error', err);
            setClaims({});
          }
        );
        return () => unsub();
      }, []);

      // –ë–æ–ª—å—à–∏–µ –º–µ—á—Ç—ã
      useEffect(() => {
        setDreamsLoading(true);
        const unsub = dreamsCol().orderBy('createdAt','desc')
          .onSnapshot(
            snap => {
              const arr = [];
              snap.forEach(doc => arr.push({ id: doc.id, ...doc.data() }));
              setDreams(arr);
              setDreamsLoading(false);
            },
            err => { console.error(err); setDreamsLoading(false); }
          );
        return () => unsub();
      }, []);

      const trimmedName = (userName || '').trim();
      const isIraViewer = normalize(trimmedName).startsWith(IRA_KEY);

      // –ü–æ–¥–∞—Ä–∫–∏ –ò—Ä—ã (ownerName –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "–ò—Ä–∞")
      const iraWishes = useMemo(
        () => items.filter(
          i => i.ownerName && normalize(i.ownerName).startsWith(IRA_KEY)
        ),
        [items]
      );

      const handleAddWish = async ({ title, url, note, image }) => {
        setAddError('');
        if (!authUid) {
          setAddError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
          return;
        }
        try {
          await itemsCol().add({
            title,
            url,
            note,
            image: image || null,
            ownerName: '–ò—Ä–∞',
            addedByUid: authUid,
            createdAt: Date.now()
          });
        } catch (e) {
          console.error(e);
          setAddError('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏–ª–∏ Firestore Rules.');
        }
      };

      const handleUpdateWish = async (wishId, updates) => {
        setAddError('');
        try {
          await itemsCol().doc(wishId).update(updates);
        } catch (e) {
          console.error(e);
          setAddError('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Firestore Rules.');
        }
      };

      const handleDeleteWish = async (wishId) => {
        setAddError('');
        try {
          await itemsCol().doc(wishId).delete();
        } catch (e) {
          console.error(e);
          setAddError('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Firestore Rules.');
        }
      };

      const handleAddDream = async ({ title, description, link, qrImage }) => {
        setDreamError('');
        if (!authUid) {
          setDreamError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
          return;
        }
        try {
          await dreamsCol().add({
            title,
            description,
            link,
            qrImage: qrImage || null,
            ownerName: '–ò—Ä–∞',
            addedByUid: authUid,
            createdAt: Date.now()
          });
        } catch (e) {
          console.error(e);
          setDreamError('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –º–µ—á—Ç—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Firestore Rules.');
        }
      };

      const handleUpdateDream = async (dreamId, updates) => {
        setDreamError('');
        try {
          await dreamsCol().doc(dreamId).update(updates);
        } catch (e) {
          console.error(e);
          setDreamError('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –º–µ—á—Ç—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Firestore Rules.');
        }
      };

      const handleDeleteDream = async (dreamId) => {
        setDreamError('');
        try {
          await dreamsCol().doc(dreamId).delete();
        } catch (e) {
          console.error(e);
          setDreamError('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –º–µ—á—Ç—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Firestore Rules.');
        }
      };

      const handleClaim = async (wish) => {
        setClaimError('');
        const name = trimmedName;
        if (!name) {
          setClaimError('–°–Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏—Ç–µ, –∫–∞–∫ –∫ –≤–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è.');
          return;
        }

        const ref = claimsCol().doc(wish.id);

        try {
          await db.runTransaction(async (tx) => {
            const snap = await tx.get(ref);
            if (snap.exists) {
              throw new Error('already-claimed');
            }
            tx.set(ref, {
              claimerUid: authUid || null,
              claimerName: name,
              createdAt: Date.now()
            });
          });
        } catch (e) {
          console.error(e);
          if (e.message === 'already-claimed') {
            setClaimError('–≠—Ç–æ—Ç –ø–æ–¥–∞—Ä–æ–∫ —É–∂–µ –∫—Ç–æ-—Ç–æ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–ª.');
          } else {
            setClaimError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
          }
        }
      };

      const handleUnclaim = async (wish) => {
        setClaimError('');
        if (!window.confirm('–°–Ω—è—Ç—å –±—Ä–æ–Ω—å —Å —ç—Ç–æ–≥–æ –ø–æ–¥–∞—Ä–∫–∞? –ï–≥–æ —Å–º–æ–∂–µ—Ç –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∫—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–π.')) {
          return;
        }

        const ref = claimsCol().doc(wish.id);

        try {
          await db.runTransaction(async (tx) => {
            const snap = await tx.get(ref);
            if (!snap.exists) {
              throw new Error('no-claim');
            }
            const data = snap.data();
            if (
              (data.claimerUid && data.claimerUid === authUid) ||
              (!data.claimerUid && normalize(data.claimerName) === normalize(trimmedName))
            ) {
              tx.delete(ref);
            } else {
              throw new Error('not-owner');
            }
          });
        } catch (e) {
          console.error(e);
          if (e.message === 'no-claim') {
            setClaimError('–ë—Ä–æ–Ω—å —É–∂–µ —Å–Ω—è—Ç–∞.');
          } else if (e.message === 'not-owner') {
            setClaimError('–°–Ω—è—Ç—å –±—Ä–æ–Ω—å –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–æ—Ç, –∫—Ç–æ –µ—ë –ø–æ—Å—Ç–∞–≤–∏–ª.');
          } else {
            setClaimError('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–Ω—è—Ç—å –±—Ä–æ–Ω—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
          }
        }
      };

      return (
        <div className="pb-10">
          <Header />
          <WhoAreYouCard userName={userName} setUserName={setUserName} />

          {!trimmedName && (
            <main className="container-narrow">
              <p className="note">
                –ü–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –≤—ã —É–∫–∞–∂–µ—Ç–µ —Å–≤–æ—ë –∏–º—è, –æ—Ç–∫—Ä–æ–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ –ø–æ–¥–∞—Ä–∫–æ–≤ –∏ –±–æ–ª—å—à–∏—Ö –º–µ—á—Ç.
              </p>
            </main>
          )}

          {/* –†–µ–∂–∏–º –ò—Ä—ã */}
          {trimmedName && isIraViewer && (
            <main className="container-narrow space-y-4">
              <AddWishFormIra
                onAdd={handleAddWish}
                disabled={!authUid}
                error={addError}
              />

              <section className="space-y-2">
                <h2 className="text-sm font-semibold text-slate-800 flex items-center gap-2">
                  –ú–æ–π —Å–ø–∏—Å–æ–∫ –ø–æ–¥–∞—Ä–∫–æ–≤
                  {itemsLoading && <span className="note">(–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è‚Ä¶)</span>}
                </h2>
                <p className="note">
                  –≠—Ç–æ—Ç —Å–ø–∏—Å–æ–∫ —É–≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Ç–µ, –∫–æ–º—É –≤—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ —Å—Å—ã–ª–∫—É. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–º, –∫—Ç–æ —á—Ç–æ –¥–∞—Ä–∏—Ç,
                  –∑–¥–µ—Å—å –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è ‚Äî –ø—É—Å—Ç—å –±—É–¥–µ—Ç —Å—é—Ä–ø—Ä–∏–∑.
                </p>

                {iraWishes.length === 0 && !itemsLoading && (
                  <p className="note">
                    –ü–æ–∫–∞ –∑–¥–µ—Å—å –ø—É—Å—Ç–æ. –î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—É–Ω–∫—Ç.
                  </p>
                )}

                <div className="grid gap-3 md:grid-cols-2">
                  {iraWishes.map(w => (
                    <WishCardIra
                      key={w.id}
                      wish={w}
                      onDelete={handleDeleteWish}
                      onUpdate={handleUpdateWish}
                      onImageClick={setPreviewImage}
                    />
                  ))}
                </div>
              </section>

              <section className="space-y-2">
                <AddDreamFormIra
                  onAdd={handleAddDream}
                  disabled={!authUid}
                  error={dreamError}
                />

                <h2 className="text-sm font-semibold text-slate-800 flex items-center gap-2">
                  –ú–æ–∏ –±–æ–ª—å—à–∏–µ –º–µ—á—Ç—ã
                  {dreamsLoading && <span className="note">(–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è‚Ä¶)</span>}
                </h2>
                <p className="note">
                  –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å –∏–¥–µ–∏ –¥–æ—Ä–æ–≥–∏—Ö –ø–æ–¥–∞—Ä–∫–æ–≤, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –±–ª–∏–∑–∫–∏–µ –º–æ–≥—É—Ç —Å–∫–∏–Ω—É—Ç—å—Å—è.
                  –ì–æ—Å—Ç–∏ —É–≤–∏–¥—è—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ –∏ (–µ—Å–ª–∏ –µ—Å—Ç—å) QR-–∫–æ–¥ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞.
                </p>

                {dreams.filter(d => d.ownerName && normalize(d.ownerName).startsWith(IRA_KEY)).length === 0 &&
                  !dreamsLoading && (
                    <p className="note">
                      –ü–æ–∫–∞ –±–æ–ª—å—à–∏—Ö –º–µ—á—Ç –Ω–µ—Ç. –î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É üòâ
                    </p>
                )}

                <div className="grid gap-3 md:grid-cols-2">
                  {dreams
                    .filter(d => d.ownerName && normalize(d.ownerName).startsWith(IRA_KEY))
                    .map(d => (
                      <DreamCardIra
                        key={d.id}
                        dream={d}
                        onDelete={handleDeleteDream}
                        onUpdate={handleUpdateDream}
                        onImageClick={setPreviewImage}
                      />
                    ))}
                </div>
              </section>
            </main>
          )}

          {/* –†–µ–∂–∏–º –≥–æ—Å—Ç—è */}
          {trimmedName && !isIraViewer && (
            <main className="container-narrow space-y-4">
              <section className="space-y-2">
                <h2 className="text-sm font-semibold text-slate-800 flex items-center gap-2">
                  –ò–¥–µ–∏ –ø–æ–¥–∞—Ä–∫–æ–≤ –¥–ª—è –ò—Ä—ã
                  {itemsLoading && <span className="note">(–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è‚Ä¶)</span>}
                </h2>
                <p className="note">
                  –í—ã–±–µ—Ä–∏—Ç–µ, —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–¥–∞—Ä–∏—Ç—å. –ü–æ—Å–ª–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥—Ä—É–≥–∏–µ —É–≤–∏–¥—è—Ç, —á—Ç–æ —ç—Ç–æ—Ç –ø–æ–¥–∞—Ä–æ–∫ –∑–∞–Ω—è—Ç,
                  –∞ –¥–ª—è –ò—Ä—ã —ç—Ç–æ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è —Å—é—Ä–ø—Ä–∏–∑–æ–º üéÅ
                </p>

                {claimError && <div className="err">{claimError}</div>}

                {iraWishes.length === 0 && !itemsLoading && (
                  <p className="note">
                    –ü–æ–∫–∞ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç. –°–∫–∞–∂–∏—Ç–µ –ò—Ä–µ, —á—Ç–æ –∂–¥—ë—Ç–µ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è üôÇ
                  </p>
                )}

                <div className="grid gap-3 md:grid-cols-2">
                  {iraWishes.map(w => (
                    <WishCardGuest
                      key={w.id}
                      wish={w}
                      claim={claims[w.id]}
                      currentUserName={trimmedName}
                      onClaim={() => handleClaim(w)}
                      onUnclaim={() => handleUnclaim(w)}
                      onImageClick={setPreviewImage}
                    />
                  ))}
                </div>
              </section>

              <section className="space-y-2">
                <h2 className="text-sm font-semibold text-slate-800 flex items-center gap-2">
                  –ë–æ–ª—å—à–∏–µ –º–µ—á—Ç—ã –ò—Ä—ã
                  {dreamsLoading && <span className="note">(–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è‚Ä¶)</span>}
                </h2>
                <p className="note">
                  –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–æ–¥–∞—Ä–∏—Ç—å –≤–µ—â—å, –∞ –≤–ª–æ–∂–∏—Ç—å—Å—è –≤ –º–µ—á—Ç—É ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –Ω–∏–∂–µ.
                  –î–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–µ—á—Ç –µ—Å—Ç—å QR-–∫–æ–¥ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞.
                </p>

                {dreams.filter(d => d.ownerName && normalize(d.ownerName).startsWith(IRA_KEY)).length === 0 &&
                  !dreamsLoading && (
                    <p className="note">
                      –ò—Ä–∞ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–∏–ª–∞ —Å—é–¥–∞ –±–æ–ª—å—à–∏–µ –º–µ—á—Ç—ã.
                    </p>
                )}

                <div className="grid gap-3 md:grid-cols-2">
                  {dreams
                    .filter(d => d.ownerName && normalize(d.ownerName).startsWith(IRA_KEY))
                    .map(d => (
                      <DreamCardGuest
                        key={d.id}
                        dream={d}
                        onImageClick={setPreviewImage}
                      />
                    ))}
                </div>
              </section>
            </main>
          )}

          {previewImage && (
            <div
              className="fixed inset-0 z-50 bg-black/70 flex items-center justify-center p-4"
              onClick={() => setPreviewImage(null)}
            >
              <div className="relative max-h-full max-w-full">
                <button
                  className="absolute -top-3 -right-3 bg-white rounded-full w-8 h-8 flex items-center justify-center text-slate-700 shadow-lg text-sm"
                  onClick={(e) => { e.stopPropagation(); setPreviewImage(null); }}
                  aria-label="–ó–∞–∫—Ä—ã—Ç—å"
                >
                  ‚úï
                </button>
                <img
                  src={previewImage}
                  alt="–ü–æ–¥–∞—Ä–æ–∫"
                  className="max-h-full max-w-full rounded-2xl shadow-2xl bg-white"
                  onClick={(e) => e.stopPropagation()}
                />
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
