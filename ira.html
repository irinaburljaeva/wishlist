<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ü–æ–¥–∞—Ä–∫–∏ –¥–ª—è –ò—Ä—ã ‚Äî —Å–µ–º–µ–π–Ω—ã–π –≤–∏—à-–ª–∏—Å—Ç</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      min-height: 100vh;
      margin: 0;
    }

    .container-narrow { max-width: 960px; margin: 0 auto; padding: 0 16px; }

    .card {
      background:#ffffff;
      border-radius:24px;
      box-shadow:0 20px 40px rgba(15,23,42,.10);
      border:1px solid rgba(148,163,184,.25);
    }

    .btn {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:999px;
      padding:10px 16px;
      font-size:14px;
      font-weight:600;
    }
    .btn-primary {
      background:linear-gradient(135deg,#f97316,#facc15);
      color:#111827;
    }
    .btn-primary:disabled { opacity:.6; cursor:not-allowed; }

    .input {
      width:100%;
      border-radius:16px;
      border:1px solid #e2e8f0;
      padding:10px 14px;
      outline:none;
      background:#f8fafc;
    }
    .input:focus {
      border-color:#fb923c;
      box-shadow:0 0 0 3px rgba(251,146,60,.25);
      background:#ffffff;
    }

    .badge {
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius:999px;
      background:#fefce8;
      color:#92400e;
      font-size:11px;
      padding:4px 9px;
    }
    .err { color:#b91c1c; font-size:13px; }
    .note { color:#64748b; font-size:13px; }
  </style>
</head>
<body>
  <!-- –§–æ–Ω -->
  <img
    src="D1EA6935-8F4B-495D-8B1F-C5BEE102DFE8.png"
    alt=""
    class="fixed inset-0 w-full h-full object-cover -z-20"
  />
  <div class="fixed inset-0 bg-white/50 backdrop-blur-md -z-10"></div>

  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useState, useMemo } = React;

    // === Firebase init ===
    const firebaseConfig = {
      apiKey: "AIzaSyC26Xjjr0pFQDVFtCgRyteEpNEjngVOJFI",
      authDomain: "wishlist-37819.firebaseapp.com",
      projectId: "wishlist-37819",
      storageBucket: "wishlist-37819.firebasestorage.app",
      messagingSenderId: "72495355387",
      appId: "1:72495355387:web:0ff709125d3cf33c8c275e"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    auth.signInAnonymously().catch(console.error);

    // –¢–æ—Ç –∂–µ —Å–ø–∏—Å–æ–∫, —á—Ç–æ –∏ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π
    const LIST_ID = 'newyear2025';
    const listDoc  = db.collection('lists').doc(LIST_ID);
    const itemsCol = () => listDoc.collection('items');
    const claimsCol = () => listDoc.collection('claims');

    // –ò–º—è ¬´–≤–ª–∞–¥–µ–ª—å—Ü–∞¬ª —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Äî
    // –ü–û–î–°–¢–†–û–ö–ê: –µ—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å ¬´–ò—Ä–∏–Ω–∞¬ª –∏–ª–∏ –¥—Ä—É–≥–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ ‚Äî –º–µ–Ω—è–µ—à—å —Ç—É—Ç
    const WISH_OWNER_NAME = '–ò—Ä–∞';

    const saveLocal = (k,v) => localStorage.setItem(k, JSON.stringify(v));
    const loadLocal = (k,fallback) => {
      try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : fallback; }
      catch { return fallback; }
    };

    function Header() {
      return (
        <header className="container-narrow pt-6 pb-4">
          <div className="flex items-center gap-4">
            <div className="w-11 h-11 rounded-2xl bg-gradient-to-tr from-rose-500 to-amber-300 flex items-center justify-center text-2xl shadow-lg">
              üéÑ
            </div>
            <div>
              <h1 className="text-2xl font-bold text-slate-900">
                –ü–æ–¥–∞—Ä–∫–∏ –¥–ª—è –ò—Ä—ã
              </h1>
              <p className="text-sm text-slate-600">
                –ó–¥–µ—Å—å —Å–æ–±—Ä–∞–Ω—ã –∏–¥–µ–∏ –ø–æ–¥–∞—Ä–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ò—Ä–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—á–µ—Ç –ø–æ–ª—É—á–∏—Ç—å.
              </p>
            </div>
          </div>
        </header>
      );
    }

    // –ò–º—è –¥–∞—Ä–∏—Ç–µ–ª—è
    function GiverNameCard({ userName, setUserName }) {
      const [editing, setEditing] = useState(!userName);

      useEffect(() => {
        if (!userName) setEditing(true);
      }, [userName]);

      if (editing) {
        return (
          <section className="container-narrow mb-4">
            <div className="card px-5 py-4 flex items-center gap-4">
              <div className="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center text-xl">
                üéÅ
              </div>
              <div className="flex-1">
                <div className="text-sm font-semibold text-slate-800 mb-1">
                  –ö–∞–∫ –∫ –≤–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è?
                </div>
                <input
                  className="input text-sm"
                  placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–∞—à–∞, –ü–∞–ø–∞, –ö–æ–ª–ª–µ–≥–∞‚Ä¶"
                  value={userName}
                  onChange={e => setUserName(e.target.value)}
                />
                <p className="note mt-1">
                  –ò–º—è –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ —Å–µ–º–µ–π–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞, —á—Ç–æ–±—ã –ò—Ä–∞ –ø–æ—Ç–æ–º –∑–Ω–∞–ª–∞, –∫–æ–º—É —Å–∫–∞–∑–∞—Ç—å —Å–ø–∞—Å–∏–±–æ. –ù–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∏–º–µ–Ω–∞ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è.
                </p>
                <div className="flex justify-end mt-2">
                  <button
                    className="btn btn-primary text-xs"
                    onClick={() => userName.trim() && setEditing(false)}
                    disabled={!userName.trim()}
                  >
                    –ì–æ—Ç–æ–≤–æ
                  </button>
                </div>
              </div>
            </div>
          </section>
        );
      }

      return (
        <section className="container-narrow mb-3">
          <button
            className="card px-5 py-3 w-full flex items-center justify-between hover:shadow-xl transition-shadow"
            onClick={() => setEditing(true)}
          >
            <div className="flex items-center gap-3">
              <div className="w-8 h-8 rounded-full bg-amber-100 flex items-center justify-center text-base">
                üôÇ
              </div>
              <div className="text-left">
                <div className="text-xs uppercase tracking-wide text-slate-400">
                  –í–∞—à–µ –∏–º—è
                </div>
                <div className="text-sm font-semibold text-slate-900">
                  {userName || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                </div>
              </div>
            </div>
            <div className="text-xs text-sky-700 font-medium flex items-center gap-1">
              –ò–∑–º–µ–Ω–∏—Ç—å
              <span>‚úèÔ∏è</span>
            </div>
          </button>
        </section>
      );
    }

    function WishCardForIra({ wish, claim, onClaim, onUnclaim, isMineClaim, onImageClick }) {
      const claimed = !!claim;

      return (
        <div className="card p-3">
          <div className="flex flex-col gap-2">
            {wish.image && (
              <img
                src={wish.image}
                alt=""
                className="w-full rounded-xl object-cover max-h-48 cursor-pointer"
                onClick={() => onImageClick(wish.image)}
              />
            )}

            <div className="flex items-start gap-3">
              {/* –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ */}
              <div className="flex-1 space-y-1">
                <div className="font-semibold text-sm text-slate-900">
                  {wish.title}
                </div>

                {wish.note && (
                  <div className="text-xs text-slate-600">
                    {wish.note}
                  </div>
                )}

                {wish.url && (
                  <a
                    href={wish.url}
                    target="_blank"
                    rel="noreferrer"
                    className="text-xs text-sky-700 underline inline-block"
                  >
                    –û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É
                  </a>
                )}
              </div>

              {/* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ */}
              <div className="min-w-[150px] text-right space-y-2">
                {claimed ? (
                  isMineClaim ? (
                    <div className="flex flex-col items-end gap-2">
                      <span className="text-xs px-2 py-1 rounded-lg bg-amber-100 text-amber-900 whitespace-nowrap">
                        üéÅ –í—ã –¥–∞—Ä–∏—Ç–µ —ç—Ç–æ—Ç –ø–æ–¥–∞—Ä–æ–∫
                      </span>
                      <button
                        className="btn text-xs w-full bg-white border border-slate-300 text-slate-700 hover:bg-slate-50"
                        onClick={onUnclaim}
                      >
                        –°–Ω—è—Ç—å –±—Ä–æ–Ω—å
                      </button>
                    </div>
                  ) : (
                    <button
                      className="btn text-xs w-full bg-slate-200 text-slate-500 cursor-not-allowed"
                      disabled
                    >
                      –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ
                    </button>
                  )
                ) : (
                  <button
                    className="btn btn-primary text-xs w-full transition-transform duration-150 active:scale-95"
                    onClick={onClaim}
                  >
                    –Ø –ø–æ–¥–∞—Ä—é
                  </button>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    }

    function App() {
      const [authUid, setAuthUid] = useState(null);
      const [userName, setUserName] = useState(loadLocal('nywish:giverName',''));
      const [items, setItems] = useState([]);
      const [claims, setClaims] = useState({});
      const [itemsLoading, setItemsLoading] = useState(true);
      const [claimError, setClaimError] = useState('');
      const [previewImage, setPreviewImage] = useState(null);

      useEffect(() => {
        const unsub = auth.onAuthStateChanged(u => setAuthUid(u?.uid || null));
        return () => unsub();
      }, []);

      useEffect(() => {
        saveLocal('nywish:giverName', userName);
      }, [userName]);

      // –∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∂–µ–ª–∞–Ω–∏—è, –ø–æ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ ownerName
      useEffect(() => {
        setItemsLoading(true);
        const unsub = itemsCol().orderBy('createdAt','desc')
          .onSnapshot(
            snap => {
              const arr = [];
              snap.forEach(doc => arr.push({ id: doc.id, ...doc.data() }));
              setItems(arr);
              setItemsLoading(false);
            },
            err => { console.error(err); setItemsLoading(false); }
          );
        return () => unsub();
      }, []);

      useEffect(() => {
        const unsub = claimsCol().onSnapshot(
          snap => {
            const map = {};
            snap.forEach(doc => map[doc.id] = doc.data());
            setClaims(map);
          },
          err => {
            console.error('claims error', err);
            setClaims({});
          }
        );
        return () => unsub();
      }, []);

      // –¢–æ–ª—å–∫–æ –ø–æ–¥–∞—Ä–∫–∏ –¥–ª—è –ò—Ä—ã
      const iraWishes = useMemo(
        () => items.filter(i => i.ownerName === WISH_OWNER_NAME),
        [items]
      );

      const handleClaim = async (wish) => {
        setClaimError('');
        if (!userName.trim()) {
          setClaimError('–°–Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏—Ç–µ —Å–≤–æ—ë –∏–º—è –Ω–∞–≤–µ—Ä—Ö—É.');
          return;
        }

        const ref = claimsCol().doc(wish.id);

        try {
          await db.runTransaction(async (tx) => {
            const snap = await tx.get(ref);
            if (snap.exists) {
              throw new Error('already-claimed');
            }
            tx.set(ref, {
              claimerUid: authUid,
              claimerName: userName.trim(),
              createdAt: Date.now()
            });
          });
        } catch (e) {
          console.error(e);
          if (e.message === 'already-claimed') {
            setClaimError('–≠—Ç–æ—Ç –ø–æ–¥–∞—Ä–æ–∫ —É–∂–µ –∫—Ç–æ-—Ç–æ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–ª.');
          } else {
            setClaimError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
          }
        }
      };

      const handleUnclaim = async (wish) => {
        setClaimError('');
        if (!window.confirm('–°–Ω—è—Ç—å –±—Ä–æ–Ω—å —Å —ç—Ç–æ–≥–æ –ø–æ–¥–∞—Ä–∫–∞? –ï–≥–æ —Å–º–æ–∂–µ—Ç –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∫—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–π.')) {
          return;
        }

        const ref = claimsCol().doc(wish.id);

        try {
          await db.runTransaction(async (tx) => {
            const snap = await tx.get(ref);
            if (!snap.exists) {
              throw new Error('no-claim');
            }
            const data = snap.data();
            if (data.claimerUid !== authUid) {
              throw new Error('not-owner');
            }
            tx.delete(ref);
          });
        } catch (e) {
          console.error(e);
          if (e.message === 'no-claim') {
            setClaimError('–ë—Ä–æ–Ω—å —É–∂–µ —Å–Ω—è—Ç–∞.');
          } else if (e.message === 'not-owner') {
            setClaimError('–°–Ω—è—Ç—å –±—Ä–æ–Ω—å –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–æ—Ç, –∫—Ç–æ –µ—ë –ø–æ—Å—Ç–∞–≤–∏–ª.');
          } else {
            setClaimError('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–Ω—è—Ç—å –±—Ä–æ–Ω—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
          }
        }
      };

      return (
        <div className="pb-10">
          <Header />
          <GiverNameCard userName={userName} setUserName={setUserName} />

          <main className="container-narrow space-y-4">
            <section className="space-y-2">
              <h2 className="text-sm font-semibold text-slate-800 flex items-center gap-2">
                –ò–¥–µ–∏ –ø–æ–¥–∞—Ä–∫–æ–≤ –¥–ª—è –ò—Ä—ã
                {itemsLoading && <span className="note">(–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è‚Ä¶)</span>}
              </h2>
              <p className="note">
                –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–¥–∞—Ä–∫–æ–≤ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–Ø –ø–æ–¥–∞—Ä—é¬ª. –¢–∞–∫ –≤—ã –∑–∞–±—Ä–æ–Ω–∏—Ä—É–µ—Ç–µ —ç—Ç–æ—Ç –ø—É–Ω–∫—Ç,
                —á—Ç–æ–±—ã –¥—Ä—É–≥–∏–µ –Ω–µ –∫—É–ø–∏–ª–∏ –µ–≥–æ —Ç–æ–∂–µ. –ò—Ä–∞ –Ω–µ —É–≤–∏–¥–∏—Ç, –∫—Ç–æ –∏–º–µ–Ω–Ω–æ –¥–∞—Ä–∏—Ç –µ–π –∫–∞–∫–æ–π –ø–æ–¥–∞—Ä–æ–∫.
              </p>

              {claimError && <div className="err">{claimError}</div>}

              <div className="grid gap-3 md:grid-cols-2">
                {iraWishes.map(w => {
                  const claim = claims[w.id];
                  const isMineClaim = claim && claim.claimerUid === authUid;
                  return (
                    <WishCardForIra
                      key={w.id}
                      wish={w}
                      claim={claim}
                      isMineClaim={isMineClaim}
                      onClaim={() => handleClaim(w)}
                      onUnclaim={() => handleUnclaim(w)}
                      onImageClick={setPreviewImage}
                    />
                  );
                })}
              </div>

              {iraWishes.length === 0 && !itemsLoading && (
                <p className="note">
                  –ü–æ–∫–∞ —Å–ø–∏—Å–æ–∫ –ø–æ–¥–∞—Ä–∫–æ–≤ –ø—É—Å—Ç. –ü–æ–ø—Ä–æ—Å–∏—Ç–µ –ò—Ä—É –¥–æ–±–∞–≤–∏—Ç—å –∂–µ–ª–∞–Ω–∏—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–µ–º–µ–π–Ω–æ–º –≤–∏—à-–ª–∏—Å—Ç–µ.
                </p>
              )}
            </section>
          </main>

          {previewImage && (
            <div
              className="fixed inset-0 z-50 bg-black/70 flex items-center justify-center p-4"
              onClick={() => setPreviewImage(null)}
            >
              <div className="relative max-h-full max-w-full">
                <button
                  className="absolute -top-3 -right-3 bg-white rounded-full w-8 h-8 flex items-center justify-center text-slate-700 shadow-lg text-sm"
                  onClick={(e) => { e.stopPropagation(); setPreviewImage(null); }}
                  aria-label="–ó–∞–∫—Ä—ã—Ç—å"
                >
                  ‚úï
                </button>
                <img
                  src={previewImage}
                  alt="–ü–æ–¥–∞—Ä–æ–∫"
                  className="max-h-full max-w-full rounded-2xl shadow-2xl"
                  onClick={(e) => e.stopPropagation()}
                />
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
