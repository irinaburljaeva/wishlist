<!doctype html>

<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–í–æ—Ç, —á—Ç–æ —Ö–æ—á–µ—Ç –ò—Ä–∞</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind -->

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React -->

  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>

  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase (compat) -->

  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>

  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>

  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --cream: #fdf6ee;
      --blush: #f4c4b0;
      --rose: #e8856a;
      --deep: #3b2a2a;
      --gold: #c9924a;
      --gold-light: #f0d5a8;
      --sage: #8aab96;
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Nunito', sans-serif;
      min-height: 100vh;
      margin: 0;
      background: var(--cream);
      color: var(--deep);
    }

    .serif { font-family: 'Playfair Display', serif; }

    .container-narrow { max-width: 960px; margin: 0 auto; padding: 0 16px; }

    /* Card */
    .card {
      background: rgba(255,255,255,0.82);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      border: 1px solid rgba(201,146,74,0.18);
      box-shadow: 0 8px 30px rgba(59,42,42,0.07);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 700;
      font-family: 'Nunito', sans-serif;
      cursor: pointer;
      border: none;
      transition: transform 0.15s, box-shadow 0.15s, opacity 0.15s;
    }
    .btn:active { transform: scale(0.97); }
    .btn-primary {
      background: linear-gradient(135deg, var(--rose), var(--gold));
      color: #fff;
      box-shadow: 0 4px 14px rgba(232,133,106,0.4);
    }
    .btn-primary:hover { box-shadow: 0 6px 20px rgba(232,133,106,0.5); transform: translateY(-1px); }
    .btn-primary:disabled { opacity: .5; cursor: not-allowed; transform: none; box-shadow: none; }
    .btn-ghost { background: transparent; color: var(--deep); }
    .btn-outline {
      background: white;
      color: var(--deep);
      border: 1.5px solid rgba(59,42,42,0.18);
    }

    /* Inputs */
    .input, .textarea {
      width: 100%;
      border-radius: 14px;
      border: 1.5px solid rgba(201,146,74,0.25);
      padding: 10px 14px;
      outline: none;
      background: rgba(255,255,255,0.7);
      font-family: 'Nunito', sans-serif;
      font-size: 14px;
      color: var(--deep);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .input:focus, .textarea:focus {
      border-color: var(--rose);
      box-shadow: 0 0 0 3px rgba(232,133,106,0.18);
      background: white;
    }

    /* Badge */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      padding: 4px 10px;
      letter-spacing: 0.03em;
    }
    .badge-dream {
      background: linear-gradient(135deg, #f0d5a8, #e8cba0);
      color: var(--gold);
    }
    .badge-gift {
      background: rgba(138,171,150,0.15);
      color: var(--sage);
      border: 1px solid rgba(138,171,150,0.3);
    }

    .err { color: #b91c1c; font-size: 13px; }
    .note { color: #7c6b6b; font-size: 13px; }

    /* Section header decoration */
    .section-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.5rem;
      color: var(--deep);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .section-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: linear-gradient(to right, rgba(201,146,74,0.3), transparent);
    }

    /* Certificate styles */
    @keyframes certIn {
      from { opacity: 0; transform: scale(0.92) translateY(20px); }
      to   { opacity: 1; transform: scale(1) translateY(0); }
    }
    .cert-modal {
      animation: certIn 0.35s cubic-bezier(.22,.68,0,1.2) both;
    }

    /* Floating petals bg */
    @keyframes float1 {
      0%,100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-18px) rotate(8deg); }
    }
    @keyframes float2 {
      0%,100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-12px) rotate(-5deg); }
    }

    /* Dream contribution modal */
    .modal-overlay {
      background: rgba(59,42,42,0.45);
      backdrop-filter: blur(4px);
    }

    /* Contribute amount buttons */
    .amount-btn {
      border: 2px solid rgba(201,146,74,0.3);
      border-radius: 12px;
      padding: 8px 14px;
      font-family: 'Nunito', sans-serif;
      font-weight: 700;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
      background: white;
      color: var(--deep);
    }
    .amount-btn:hover, .amount-btn.selected {
      background: linear-gradient(135deg, var(--rose), var(--gold));
      color: white;
      border-color: transparent;
      box-shadow: 0 3px 10px rgba(232,133,106,0.3);
    }

    /* Print styles */
    @media print {
      body > *:not(#cert-print-area) { display: none !important; }
      #cert-print-area {
        display: block !important;
        position: fixed;
        inset: 0;
        background: white;
        z-index: 9999;
        padding: 0;
      }
      #cert-print-area .cert-inner {
        width: 100vw;
        height: 100vh;
        margin: 0;
      }
    }

    .wavy-border {
      border-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='6'%3E%3Cpath d='M0 3 Q5 0 10 3 Q15 6 20 3' stroke='%23c9924a' stroke-width='1' fill='none'/%3E%3C/svg%3E") 6 round;
    }
  </style>

</head>
<body>
  <!-- Decorative background -->
  <div class="fixed inset-0 -z-20 pointer-events-none overflow-hidden">
    <div style="position:absolute;inset:0;background:radial-gradient(ellipse 80% 60% at 20% 10%, #fde8da 0%, transparent 60%), radial-gradient(ellipse 60% 50% at 80% 80%, #f0e4d4 0%, transparent 60%), #fdf6ee;"></div>
    <svg style="position:absolute;top:-40px;right:-40px;opacity:0.12;animation:float1 8s ease-in-out infinite" width="300" height="300" viewBox="0 0 300 300"><circle cx="150" cy="150" r="120" fill="#e8856a"/><circle cx="150" cy="50" r="45" fill="#e8856a"/><circle cx="150" cy="250" r="45" fill="#e8856a"/><circle cx="50" cy="150" r="45" fill="#e8856a"/><circle cx="250" cy="150" r="45" fill="#e8856a"/></svg>
    <svg style="position:absolute;bottom:-60px;left:-40px;opacity:0.09;animation:float2 10s ease-in-out infinite" width="350" height="350" viewBox="0 0 100 100"><polygon points="50,5 95,25 95,75 50,95 5,75 5,25" fill="#c9924a"/></svg>
    <svg style="position:absolute;top:40%;left:5%;opacity:0.07;animation:float1 12s ease-in-out infinite 2s" width="120" height="120" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="none" stroke="#e8856a" stroke-width="8"/></svg>
  </div>

  <div id="root"></div>
  <!-- Print area (hidden normally) -->
  <div id="cert-print-area" style="display:none"></div>

  <script type="text/babel">
    const { useEffect, useState, useMemo, useRef } = React;

    // === Firebase init ===
    const firebaseConfig = {
      apiKey: "AIzaSyC26Xjjr0pFQDVFtCgRyteEpNEjngVOJFI",
      authDomain: "wishlist-37819.firebaseapp.com",
      projectId: "wishlist-37819",
      storageBucket: "wishlist-37819.firebasestorage.app",
      messagingSenderId: "72495355387",
      appId: "1:72495355387:web:0ff709125d3cf33c8c275e"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    auth.signInAnonymously().catch(console.error);

    const LIST_ID = 'newyear2025';
    const listDoc   = db.collection('lists').doc(LIST_ID);
    const itemsCol  = () => listDoc.collection('items');
    const claimsCol = () => listDoc.collection('claims');
    const dreamsCol = () => listDoc.collection('dreams');

    const saveLocal = (k,v) => localStorage.setItem(k, JSON.stringify(v));
    const loadLocal = (k,fb) => { try { const v=localStorage.getItem(k); return v?JSON.parse(v):fb; } catch { return fb; }};

    const normalize = s => (s||'').trim().toLowerCase();
    const IRA_KEY = '–∏—Ä–∞';

    async function compressImage(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => {
          const img = new Image();
          img.onload = () => {
            const scale = Math.min(800/img.width, 800/img.height, 1);
            const canvas = document.createElement('canvas');
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            canvas.getContext('2d').drawImage(img,0,0,canvas.width,canvas.height);
            const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
            if (dataUrl.length > 900000) { reject('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –ø–æ–º–µ–Ω—å—à–µ.'); return; }
            resolve(dataUrl);
          };
          img.onerror = () => reject('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.');
          img.src = e.target.result;
        };
        reader.onerror = () => reject('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª.');
        reader.readAsDataURL(file);
      });
    }

    // ===== CERTIFICATE GENERATOR =====
    function generateCertificateHTML(guestName, dreamTitle, amount, date) {
      const d = date || new Date();
      const dateStr = d.toLocaleDateString('ru-RU', { day:'numeric', month:'long', year:'numeric' });
      return `<!DOCTYPE html><html lang="ru"><head>
<meta charset="utf-8">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{width:794px;height:561px;background:#fdf6ee;font-family:'Nunito',sans-serif;display:flex;align-items:center;justify-content:center}
  .cert{width:750px;height:520px;background:white;position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;padding:48px}
  .outer-border{position:absolute;inset:10px;border:1.5px solid #c9924a;border-radius:4px;pointer-events:none}
  .inner-border{position:absolute;inset:16px;border:0.5px solid rgba(201,146,74,0.4);border-radius:2px;pointer-events:none}
  .corner{position:absolute;width:40px;height:40px}
  .corner svg{width:40px;height:40px}
  .tl{top:6px;left:6px} .tr{top:6px;right:6px;transform:scaleX(-1)} .bl{bottom:6px;left:6px;transform:scaleY(-1)} .br{bottom:6px;right:6px;transform:scale(-1)}
  .seal{width:70px;height:70px;border-radius:50%;background:radial-gradient(circle,#f0d5a8,#c9924a);display:flex;align-items:center;justify-content:center;font-size:30px;box-shadow:0 4px 16px rgba(201,146,74,0.4);border:3px solid rgba(255,255,255,0.8)}
  .title{font-family:'Playfair Display',serif;font-size:11px;letter-spacing:0.25em;text-transform:uppercase;color:#c9924a;font-weight:400}
  .main-title{font-family:'Playfair Display',serif;font-size:28px;color:#3b2a2a;text-align:center;line-height:1.25}
  .main-title em{font-style:italic;color:#e8856a}
  .subtitle{font-family:'Nunito',sans-serif;font-size:14px;color:#7c6b6b;text-align:center;line-height:1.6;max-width:500px}
  .amount-block{background:linear-gradient(135deg,#fde8da,#f0d5a8);border-radius:12px;padding:10px 28px;border:1px solid rgba(201,146,74,0.25)}
  .amount-label{font-size:10px;letter-spacing:0.15em;text-transform:uppercase;color:#c9924a;text-align:center;margin-bottom:2px}
  .amount-value{font-family:'Playfair Display',serif;font-size:22px;color:#3b2a2a;text-align:center}
  .divider{width:120px;height:1px;background:linear-gradient(to right,transparent,#c9924a,transparent)}
  .footer{display:flex;justify-content:space-between;width:100%;padding-top:10px;border-top:0.5px solid rgba(201,146,74,0.3)}
  .footer-item{display:flex;flex-direction:column;gap:2px}
  .footer-label{font-size:9px;letter-spacing:0.15em;text-transform:uppercase;color:#c9924a}
  .footer-value{font-family:'Playfair Display',serif;font-size:13px;color:#3b2a2a}
</style>

</head><body>
<div class="cert">
  <div class="outer-border"></div>
  <div class="inner-border"></div>
  <div class="corner tl"><svg viewBox="0 0 40 40"><path d="M2 2 L2 20 M2 2 L20 2" stroke="#c9924a" stroke-width="2" fill="none" stroke-linecap="round"/><circle cx="2" cy="2" r="2" fill="#c9924a"/><path d="M8 2 L8 8 L2 8" stroke="rgba(201,146,74,0.4)" stroke-width="0.8" fill="none"/></svg></div>
  <div class="corner tr"><svg viewBox="0 0 40 40"><path d="M2 2 L2 20 M2 2 L20 2" stroke="#c9924a" stroke-width="2" fill="none" stroke-linecap="round"/><circle cx="2" cy="2" r="2" fill="#c9924a"/><path d="M8 2 L8 8 L2 8" stroke="rgba(201,146,74,0.4)" stroke-width="0.8" fill="none"/></svg></div>
  <div class="corner bl"><svg viewBox="0 0 40 40"><path d="M2 2 L2 20 M2 2 L20 2" stroke="#c9924a" stroke-width="2" fill="none" stroke-linecap="round"/><circle cx="2" cy="2" r="2" fill="#c9924a"/><path d="M8 2 L8 8 L2 8" stroke="rgba(201,146,74,0.4)" stroke-width="0.8" fill="none"/></svg></div>
  <div class="corner br"><svg viewBox="0 0 40 40"><path d="M2 2 L2 20 M2 2 L20 2" stroke="#c9924a" stroke-width="2" fill="none" stroke-linecap="round"/><circle cx="2" cy="2" r="2" fill="#c9924a"/><path d="M8 2 L8 8 L2 8" stroke="rgba(201,146,74,0.4)" stroke-width="0.8" fill="none"/></svg></div>

  <div class="seal">‚ú®</div>
  <div class="title">–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É—á–∞—Å—Ç–∏—è –≤ –º–µ—á—Ç–µ</div>
  <div class="main-title">
    <em>${guestName}</em> –≤–ª–æ–∂–∏–ª${guestName.slice(-1) === '–∞' ? '–∞' : ''}<br>–≤ –±–æ–ª—å—à—É—é –º–µ—á—Ç—É
  </div>
  <div class="divider"></div>
  <div class="subtitle">–ù–∞—Å—Ç–æ—è—â–∏–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è, —á—Ç–æ <strong>${guestName}</strong> –≤–Ω—ë—Å${guestName.slice(-1) === '–∞' ? '–ª–∞' : ''} —Å–≤–æ–π –≤–∫–ª–∞–¥ –≤ –æ—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω–∏–µ –º–µ—á—Ç—ã <strong>¬´${dreamTitle}¬ª</strong> –∏ —è–≤–ª—è–µ—Ç—Å—è —Å–æ–∞–≤—Ç–æ—Ä–æ–º —ç—Ç–æ–≥–æ —Ä–∞–¥–æ—Å—Ç–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è.</div>
  <div class="amount-block">
    <div class="amount-label">–í–∫–ª–∞–¥ –≤ –º–µ—á—Ç—É</div>
    <div class="amount-value">${amount} ‚ÇΩ</div>
  </div>
  <div class="footer">
    <div class="footer-item">
      <span class="footer-label">–ü–æ–ª—É—á–∞—Ç–µ–ª—å –º–µ—á—Ç—ã</span>
      <span class="footer-value">–ò—Ä–∞ üå∏</span>
    </div>
    <div class="footer-item" style="align-items:center">
      <span class="footer-label">–ú–µ—á—Ç–∞</span>
      <span class="footer-value" style="text-align:center;font-size:12px">${dreamTitle.length > 30 ? dreamTitle.slice(0,30)+'‚Ä¶' : dreamTitle}</span>
    </div>
    <div class="footer-item" style="align-items:flex-end">
      <span class="footer-label">–î–∞—Ç–∞</span>
      <span class="footer-value">${dateStr}</span>
    </div>
  </div>
</div>
</body>

function printCertificate(guestName, dreamTitle, amount) {
  const html = generateCertificateHTML(guestName, dreamTitle, amount);
  const w = window.open('','_blank','width=850,height=620');
  if (!w) { alert('–†–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Å–∞–π—Ç–∞'); return; }
  w.document.write(html);
  w.document.close();
  w.onload = () => { w.focus(); w.print(); };
}

// ===== CONTRIBUTE MODAL =====
function ContributeModal({ dream, guestName, onClose }) {
  const [step, setStep] = useState('amount'); // 'amount' | 'qr' | 'cert'
  const [amount, setAmount] = useState('');
  const [customAmount, setCustomAmount] = useState('');
  const presets = [500, 1000, 2000, 5000];
  const finalAmount = amount || customAmount;

  const handlePrint = () => {
    printCertificate(guestName, dream.title, finalAmount + ' ‚ÇΩ');
  };

  return (
    <div
      className="fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4"
      onClick={onClose}
    >
      <div
        className="cert-modal card w-full max-w-md p-6 relative"
        onClick={e => e.stopPropagation()}
        style={{background:'white', maxHeight:'90vh', overflowY:'auto'}}
      >
        <button
          style={{position:'absolute',top:14,right:14,width:30,height:30,borderRadius:'50%',border:'1.5px solid rgba(59,42,42,0.15)',background:'white',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',fontSize:14,color:'#7c6b6b'}}
          onClick={onClose}
        >‚úï</button>

        {step === 'amount' && (
          <>
            <div style={{marginBottom:6}} className="note">–í—ã –≤–∫–ª–∞–¥—ã–≤–∞–µ—Ç–µ—Å—å –≤ –º–µ—á—Ç—É</div>
            <div className="serif" style={{fontSize:20,color:'var(--deep)',marginBottom:20,lineHeight:1.3}}>¬´{dream.title}¬ª</div>
            
            <div style={{marginBottom:16}}>
              <div style={{fontSize:13,fontWeight:700,marginBottom:10,color:'var(--deep)'}}>–í—ã–±–µ—Ä–∏—Ç–µ —Å—É–º–º—É –≤–∫–ª–∞–¥–∞:</div>
              <div style={{display:'flex',flexWrap:'wrap',gap:8,marginBottom:12}}>
                {presets.map(p => (
                  <button
                    key={p}
                    className={`amount-btn ${amount == p ? 'selected' : ''}`}
                    onClick={() => { setAmount(p); setCustomAmount(''); }}
                  >{p.toLocaleString('ru')} ‚ÇΩ</button>
                ))}
              </div>
              <div style={{display:'flex',alignItems:'center',gap:8}}>
                <input
                  className="input"
                  type="number"
                  placeholder="–°–≤–æ—è —Å—É–º–º–∞, ‚ÇΩ"
                  value={customAmount}
                  onChange={e => { setCustomAmount(e.target.value); setAmount(''); }}
                  style={{flex:1}}
                />
              </div>
            </div>

            {dream.qrImage && (
              <div style={{background:'rgba(201,146,74,0.07)',borderRadius:14,padding:14,marginBottom:16,textAlign:'center'}}>
                <div className="note" style={{marginBottom:8}}>–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ —á—Ç–æ–±—ã –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –¥–µ–Ω—å–≥–∏</div>
                <img
                  src={dream.qrImage}
                  alt="QR"
                  style={{width:150,height:150,objectFit:'contain',background:'white',borderRadius:10,padding:4,margin:'0 auto',display:'block'}}
                />
              </div>
            )}
            {!dream.qrImage && (
              <div className="note" style={{marginBottom:16,padding:'10px 14px',background:'rgba(201,146,74,0.07)',borderRadius:12}}>
                üí¨ –£—Ç–æ—á–Ω–∏—Ç–µ —É –ò—Ä—ã, –∫–∞–∫ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –¥–µ–Ω—å–≥–∏ ‚Äî –æ–Ω–∞ –ø–æ–¥—Å–∫–∞–∂–µ—Ç!
              </div>
            )}

            <button
              className="btn btn-primary"
              style={{width:'100%'}}
              disabled={!finalAmount || Number(finalAmount) < 1}
              onClick={() => setStep('cert')}
            >
              –ü–æ–ª—É—á–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç ‚ú®
            </button>
          </>
        )}

        {step === 'cert' && (
          <>
            <div style={{textAlign:'center',marginBottom:16}}>
              <div style={{fontSize:48,marginBottom:8}}>üéâ</div>
              <div className="serif" style={{fontSize:22,color:'var(--deep)',marginBottom:6}}>
                –°–ø–∞—Å–∏–±–æ, {guestName}!
              </div>
              <div className="note">
                –í—ã –≤–ª–æ–∂–∏–ª–∏ <strong>{Number(finalAmount).toLocaleString('ru')} ‚ÇΩ</strong> –≤ –º–µ—á—Ç—É ¬´{dream.title}¬ª
              </div>
            </div>

            <div style={{background:'linear-gradient(135deg,#fde8da,#f0d5a8)',borderRadius:16,padding:20,marginBottom:20,border:'1px solid rgba(201,146,74,0.25)'}}>
              <div style={{fontFamily:"'Playfair Display',serif",fontSize:14,textAlign:'center',color:'#3b2a2a',marginBottom:6}}>
                –í–∞—à —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≥–æ—Ç–æ–≤ –∫ –ø–µ—á–∞—Ç–∏
              </div>
              <div className="note" style={{textAlign:'center',fontSize:12}}>
                –†–∞—Å–ø–µ—á–∞—Ç–∞–π—Ç–µ, –≤–ª–æ–∂–∏—Ç–µ –≤ –æ—Ç–∫—Ä—ã—Ç–∫—É –∏ –ø–æ–¥–∞—Ä–∏—Ç–µ –ò—Ä–µ –≤ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è üå∏
              </div>
            </div>

            {/* Mini preview */}
            <div style={{border:'1.5px solid rgba(201,146,74,0.3)',borderRadius:14,padding:16,marginBottom:20,background:'white',position:'relative',textAlign:'center'}}>
              <div style={{position:'absolute',top:8,right:8,fontSize:16}}>‚ú®</div>
              <div style={{fontSize:9,letterSpacing:'0.2em',textTransform:'uppercase',color:'var(--gold)',marginBottom:6}}>–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É—á–∞—Å—Ç–∏—è –≤ –º–µ—á—Ç–µ</div>
              <div style={{fontFamily:"'Playfair Display',serif",fontSize:16,color:'var(--deep)',marginBottom:4}}>
                <em style={{color:'var(--rose)'}}>{guestName}</em> –≤–ª–æ–∂–∏–ª{guestName.slice(-1)==='–∞'?'–∞':''}<br/>–≤ –±–æ–ª—å—à—É—é –º–µ—á—Ç—É
              </div>
              <div style={{width:60,height:1,background:'linear-gradient(to right,transparent,#c9924a,transparent)',margin:'8px auto'}}></div>
              <div style={{fontSize:11,color:'#7c6b6b',marginBottom:8}}>¬´{dream.title}¬ª</div>
              <div style={{display:'inline-block',background:'linear-gradient(135deg,#fde8da,#f0d5a8)',borderRadius:8,padding:'4px 12px'}}>
                <div style={{fontSize:9,letterSpacing:'0.12em',textTransform:'uppercase',color:'var(--gold)'}}>–í–∫–ª–∞–¥</div>
                <div style={{fontFamily:"'Playfair Display',serif",fontSize:15,color:'var(--deep)'}}>{Number(finalAmount).toLocaleString('ru')} ‚ÇΩ</div>
              </div>
            </div>

            <div style={{display:'flex',gap:10}}>
              <button className="btn btn-outline" style={{flex:1}} onClick={onClose}>
                –ó–∞–∫—Ä—ã—Ç—å
              </button>
              <button className="btn btn-primary" style={{flex:2}} onClick={handlePrint}>
                üñ®Ô∏è –ü–µ—á–∞—Ç–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
              </button>
            </div>
          </>
        )}
      </div>
    </div>
  );
}

// ===== HEADER =====
function Header() {
  return (
    <header className="container-narrow pt-8 pb-4">
      <div style={{textAlign:'center'}}>
        <div style={{fontSize:40,marginBottom:8}}>üå∏</div>
        <h1 className="serif" style={{fontSize:'2rem',color:'var(--deep)',marginBottom:4}}>
          –ü–æ–¥–∞—Ä–æ—á–∫–∏ –¥–ª—è –ò—Ä—ã
        </h1>
        <p className="note">–ó–¥–µ—Å—å —Å–æ–±—Ä–∞–Ω—ã –∏–¥–µ–∏ –ø–æ–¥–∞—Ä–∫–æ–≤ –∏ –±–æ–ª—å—à–∏–µ –º–µ—á—Ç—ã</p>
      </div>
    </header>
  );
}

// ===== WHO ARE YOU =====
function WhoAreYouCard({ userName, setUserName }) {
  const [temp, setTemp] = useState(userName || '');
  return (
    <section className="container-narrow mb-6">
      <div className="card px-6 py-5" style={{display:'flex',gap:16,alignItems:'flex-start'}}>
        <div style={{width:44,height:44,borderRadius:'50%',background:'linear-gradient(135deg,#fde8da,#f0d5a8)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:22,flexShrink:0}}>üëã</div>
        <div style={{flex:1}}>
          <div style={{fontWeight:700,color:'var(--deep)',marginBottom:4}}>–î–∞–≤–∞–π—Ç–µ –ø–æ–∑–Ω–∞–∫–æ–º–∏–º—Å—è</div>
          <p className="note" style={{marginBottom:12}}>–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ –∏–º—è ‚Äî –≤—ã —Å–º–æ–∂–µ—Ç–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–∞—Ä–æ–∫ –∏–ª–∏ –≤–ª–æ–∂–∏—Ç—å—Å—è –≤ –º–µ—á—Ç—É.</p>
          <div style={{display:'flex',gap:8,flexWrap:'wrap'}}>
            <input
              className="input"
              style={{flex:1,minWidth:180}}
              placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–Ω—Ç–æ–Ω, –ù–∞—Å—Ç—è, –ú–∞—à–∞"
              value={temp}
              onChange={e => setTemp(e.target.value)}
              onKeyDown={e => e.key==='Enter' && temp.trim() && setUserName(temp.trim())}
            />
            <button
              className="btn btn-primary"
              onClick={() => setUserName(temp.trim())}
              disabled={!temp.trim()}
            >–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
          </div>
        </div>
      </div>
    </section>
  );
}

// ===== IRA: ADD WISH FORM =====
function AddWishFormIra({ onAdd, disabled, error }) {
  const [title,setTitle]=useState('');const [url,setUrl]=useState('');const [note,setNote]=useState('');
  const [imageData,setImageData]=useState('');const [imageError,setImageError]=useState('');const [imageLoading,setImageLoading]=useState(false);
  const submit = () => { if(disabled||!title.trim())return; onAdd({title:title.trim(),url:url.trim(),note:note.trim(),image:imageData}); setTitle('');setUrl('');setNote('');setImageData('');setImageError(''); };
  const handleFileChange = async e => {
    const file=e.target.files&&e.target.files[0]; if(!file){setImageData('');setImageError('');return;}
    setImageLoading(true);setImageError('');
    try{const c=await compressImage(file);setImageData(c);}catch(err){setImageData('');setImageError(typeof err==='string'?err:'–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.');}finally{setImageLoading(false);}
  };
  return (
    <div className="card p-5 mb-4">
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:14}}>
        <h2 className="serif" style={{fontSize:18,color:'var(--deep)'}}>–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫</h2>
        <span className="badge badge-gift">üéÅ –°–ø–∏—Å–æ–∫ –ø–æ–¥–∞—Ä–∫–æ–≤</span>
      </div>
      <div style={{display:'flex',flexDirection:'column',gap:10}}>
        <input className="input" placeholder="–ß—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å? (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç—ë–ø–ª—ã–π –ø–ª–µ–¥)" value={title} onChange={e=>setTitle(e.target.value)} />
        <input className="input" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä" value={url} onChange={e=>setUrl(e.target.value)} />
        <textarea className="textarea" style={{resize:'none'}} rows="2" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: —Ü–≤–µ—Ç, —Ä–∞–∑–º–µ—Ä, –Ω—é–∞–Ω—Å—ã‚Ä¶" value={note} onChange={e=>setNote(e.target.value)} />
        <div>
          <label style={{fontSize:13,fontWeight:600,color:'var(--deep)',display:'block',marginBottom:6}}>–§–æ—Ç–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
          <input type="file" accept="image/*" className="input" onChange={handleFileChange} />
          {imageLoading && <div className="note" style={{marginTop:4}}>–°–∂–∏–º–∞–µ—Ç—Å—è‚Ä¶</div>}
          {imageError && <div className="err" style={{marginTop:4}}>{imageError}</div>}
          {imageData && !imageLoading && <img src={imageData} alt="" style={{borderRadius:14,marginTop:8,maxHeight:140,width:'100%',objectFit:'cover'}} />}
        </div>
        {error && <div className="err">{error}</div>}
        <div style={{display:'flex',justifyContent:'flex-end'}}>
          <button className="btn btn-primary" onClick={submit} disabled={disabled}>‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </div>
    </div>
  );
}

// ===== IRA: ADD DREAM FORM =====
function AddDreamFormIra({ onAdd, disabled, error }) {
  const [title,setTitle]=useState('');const [desc,setDesc]=useState('');const [link,setLink]=useState('');
  const [qrImage,setQrImage]=useState('');const [imgError,setImgError]=useState('');const [imgLoading,setImgLoading]=useState(false);
  const submit = () => { if(disabled||!title.trim())return; onAdd({title:title.trim(),description:desc.trim(),link:link.trim(),qrImage:qrImage||null}); setTitle('');setDesc('');setLink('');setQrImage('');setImgError(''); };
  const handleQrChange = async e => {
    const file=e.target.files&&e.target.files[0]; if(!file){setQrImage('');setImgError('');return;}
    setImgLoading(true);setImgError('');
    try{const c=await compressImage(file);setQrImage(c);}catch(err){setQrImage('');setImgError(typeof err==='string'?err:'–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.');}finally{setImgLoading(false);}
  };
  return (
    <div className="card p-5 mb-4">
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:14}}>
        <h2 className="serif" style={{fontSize:18,color:'var(--deep)'}}>–î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à—É—é –º–µ—á—Ç—É</h2>
        <span className="badge badge-dream">‚ú® –°–±–æ—Ä</span>
      </div>
      <div style={{display:'flex',flexDirection:'column',gap:10}}>
        <input className="input" placeholder="–û —á—ë–º –º–µ—á—Ç–∞–µ—Ç–µ? (–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ, –æ–±—ä–µ–∫—Ç–∏–≤‚Ä¶)" value={title} onChange={e=>setTitle(e.target.value)} />
        <textarea className="textarea" style={{resize:'none'}} rows="2" placeholder="–ö–æ—Ä–æ—Ç–∫–æ –æ–ø–∏—à–∏—Ç–µ –º–µ—á—Ç—É" value={desc} onChange={e=>setDesc(e.target.value)} />
        <input className="input" placeholder="–°—Å—ã–ª–∫–∞ —Å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—è–º–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" value={link} onChange={e=>setLink(e.target.value)} />
        <div>
          <label style={{fontSize:13,fontWeight:600,color:'var(--deep)',display:'block',marginBottom:6}}>QR-–∫–æ–¥ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
          <input type="file" accept="image/*" className="input" onChange={handleQrChange} />
          {imgLoading && <div className="note" style={{marginTop:4}}>–°–∂–∏–º–∞–µ—Ç—Å—è‚Ä¶</div>}
          {imgError && <div className="err" style={{marginTop:4}}>{imgError}</div>}
          {qrImage && !imgLoading && <img src={qrImage} alt="QR" style={{borderRadius:14,marginTop:8,maxHeight:140,width:'100%',objectFit:'contain',background:'white'}} />}
        </div>
        {error && <div className="err">{error}</div>}
        <div style={{display:'flex',justifyContent:'flex-end'}}>
          <button className="btn btn-primary" onClick={submit} disabled={disabled}>‚ú® –î–æ–±–∞–≤–∏—Ç—å –º–µ—á—Ç—É</button>
        </div>
      </div>
    </div>
  );
}

// ===== IRA: WISH CARD =====
function WishCardIra({ wish, onDelete, onUpdate, onImageClick }) {
  const [editing,setEditing]=useState(false);
  const [title,setTitle]=useState(wish.title||'');const [url,setUrl]=useState(wish.url||'');const [note,setNote]=useState(wish.note||'');
  const [imageData,setImageData]=useState(wish.image||'');const [imageError,setImageError]=useState('');const [imageLoading,setImageLoading]=useState(false);
  useEffect(()=>{setTitle(wish.title||'');setUrl(wish.url||'');setNote(wish.note||'');setImageData(wish.image||'');setEditing(false);},[wish.id]);
  const handleSave = async () => { if(!title.trim())return; await onUpdate(wish.id,{title:title.trim(),url:url.trim(),note:note.trim(),image:imageData||null}); setEditing(false); };
  const handleDelete = async () => { if(!window.confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ–¥–∞—Ä–æ–∫?'))return; await onDelete(wish.id); };
  const handleFileChange = async e => {
    const file=e.target.files&&e.target.files[0]; if(!file){setImageData(wish.image||'');setImageError('');return;}
    setImageLoading(true);setImageError('');
    try{const c=await compressImage(file);setImageData(c);}catch(err){setImageError(typeof err==='string'?err:'–û—à–∏–±–∫–∞.');}finally{setImageLoading(false);}
  };
  if(editing) return (
    <div className="card p-4" style={{display:'flex',flexDirection:'column',gap:10}}>
      <div style={{fontSize:11,textTransform:'uppercase',letterSpacing:'0.12em',color:'var(--gold)'}}>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
      <input className="input" value={title} onChange={e=>setTitle(e.target.value)} placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" />
      <input className="input" value={url} onChange={e=>setUrl(e.target.value)} placeholder="–°—Å—ã–ª–∫–∞" />
      <textarea className="textarea" style={{resize:'none'}} rows="2" value={note} onChange={e=>setNote(e.target.value)} placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" />
      <input type="file" accept="image/*" className="input" onChange={handleFileChange} />
      {imageLoading&&<div className="note">–°–∂–∏–º–∞–µ—Ç—Å—è‚Ä¶</div>}
      {imageError&&<div className="err">{imageError}</div>}
      {imageData&&!imageLoading&&<img src={imageData} alt="" style={{borderRadius:12,maxHeight:120,width:'100%',objectFit:'cover',cursor:'pointer'}} onClick={()=>onImageClick(imageData)} />}
      <div style={{display:'flex',gap:8,justifyContent:'flex-end',paddingTop:8,borderTop:'1px solid rgba(201,146,74,0.15)'}}>
        <button className="btn btn-outline" style={{fontSize:13}} onClick={()=>setEditing(false)}>–û—Ç–º–µ–Ω–∞</button>
        <button className="btn btn-primary" style={{fontSize:13}} onClick={handleSave}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  );
  return (
    <div className="card p-4" style={{display:'flex',flexDirection:'column',gap:10}}>
      {wish.image&&<img src={wish.image} alt="" style={{width:'100%',borderRadius:14,maxHeight:180,objectFit:'cover',cursor:'pointer'}} onClick={()=>onImageClick(wish.image)} />}
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',gap:10}}>
        <div>
          <div style={{fontWeight:700,color:'var(--deep)',fontSize:15}}>{wish.title}</div>
          {wish.note&&<div className="note" style={{marginTop:3}}>{wish.note}</div>}
          {wish.url&&<a href={wish.url} target="_blank" rel="noreferrer" style={{fontSize:12,color:'var(--rose)',textDecoration:'underline',display:'inline-block',marginTop:4}}>–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É</a>}
        </div>
        <span className="badge badge-gift" style={{flexShrink:0}}>–í —Å–ø–∏—Å–∫–µ</span>
      </div>
      <div style={{display:'flex',gap:8,justifyContent:'flex-end',paddingTop:8,borderTop:'1px solid rgba(201,146,74,0.1)'}}>
        <button className="btn btn-outline" style={{fontSize:12,padding:'6px 14px'}} onClick={()=>setEditing(true)}>–ò–∑–º–µ–Ω–∏—Ç—å</button>
        <button style={{fontSize:12,padding:'6px 14px',borderRadius:999,border:'1.5px solid #fca5a5',background:'white',color:'#b91c1c',cursor:'pointer',fontFamily:'Nunito',fontWeight:700}} onClick={handleDelete}>–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>
  );
}

// ===== IRA: DREAM CARD =====
function DreamCardIra({ dream, onDelete, onUpdate, onImageClick }) {
  const [editing,setEditing]=useState(false);
  const [title,setTitle]=useState(dream.title||'');const [desc,setDesc]=useState(dream.description||'');
  const [link,setLink]=useState(dream.link||'');const [qrImage,setQrImage]=useState(dream.qrImage||'');
  const [imgError,setImgError]=useState('');const [imgLoading,setImgLoading]=useState(false);
  useEffect(()=>{setTitle(dream.title||'');setDesc(dream.description||'');setLink(dream.link||'');setQrImage(dream.qrImage||'');setEditing(false);},[dream.id]);
  const handleSave = async () => { if(!title.trim())return; await onUpdate(dream.id,{title:title.trim(),description:desc.trim(),link:link.trim(),qrImage:qrImage||null}); setEditing(false); };
  const handleDelete = async () => { if(!window.confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –º–µ—á—Ç—É?'))return; await onDelete(dream.id); };
  const handleQrChange = async e => {
    const file=e.target.files&&e.target.files[0]; if(!file){setQrImage(dream.qrImage||'');setImgError('');return;}
    setImgLoading(true);setImgError('');
    try{const c=await compressImage(file);setQrImage(c);}catch(err){setImgError(typeof err==='string'?err:'–û—à–∏–±–∫–∞.');}finally{setImgLoading(false);}
  };
  if(editing) return (
    <div className="card p-4" style={{display:'flex',flexDirection:'column',gap:10}}>
      <div style={{fontSize:11,textTransform:'uppercase',letterSpacing:'0.12em',color:'var(--gold)'}}>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—á—Ç—ã</div>
      <input className="input" value={title} onChange={e=>setTitle(e.target.value)} placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" />
      <textarea className="textarea" style={{resize:'none'}} rows="2" value={desc} onChange={e=>setDesc(e.target.value)} placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" />
      <input className="input" value={link} onChange={e=>setLink(e.target.value)} placeholder="–°—Å—ã–ª–∫–∞" />
      <div>
        <label style={{fontSize:12,fontWeight:600,color:'var(--deep)',display:'block',marginBottom:6}}>QR-–∫–æ–¥</label>
        <input type="file" accept="image/*" className="input" onChange={handleQrChange} />
        {imgLoading&&<div className="note">–°–∂–∏–º–∞–µ—Ç—Å—è‚Ä¶</div>}
        {imgError&&<div className="err">{imgError}</div>}
        {qrImage&&!imgLoading&&<img src={qrImage} alt="QR" style={{borderRadius:12,maxHeight:120,width:'100%',objectFit:'contain',background:'white',marginTop:8,cursor:'pointer'}} onClick={()=>onImageClick(qrImage)} />}
      </div>
      <div style={{display:'flex',gap:8,justifyContent:'flex-end',paddingTop:8,borderTop:'1px solid rgba(201,146,74,0.15)'}}>
        <button className="btn btn-outline" style={{fontSize:13}} onClick={()=>setEditing(false)}>–û—Ç–º–µ–Ω–∞</button>
        <button className="btn btn-primary" style={{fontSize:13}} onClick={handleSave}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  );
  return (
    <div className="card p-4" style={{display:'flex',flexDirection:'column',gap:10}}>
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',gap:10}}>
        <div>
          <div style={{fontWeight:700,color:'var(--deep)',fontSize:15}}>{dream.title}</div>
          {dream.description&&<div className="note" style={{marginTop:3}}>{dream.description}</div>}
          {dream.link&&<a href={dream.link} target="_blank" rel="noreferrer" style={{fontSize:12,color:'var(--rose)',textDecoration:'underline',display:'inline-block',marginTop:4}}>–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>}
        </div>
        <span className="badge badge-dream" style={{flexShrink:0}}>‚ú® –ú–µ—á—Ç–∞</span>
      </div>
      {dream.qrImage&&(
        <div style={{background:'rgba(201,146,74,0.07)',borderRadius:14,padding:12,textAlign:'center'}}>
          <div className="note" style={{fontSize:11,marginBottom:6}}>QR-–∫–æ–¥ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞</div>
          <img src={dream.qrImage} alt="QR" style={{width:120,height:120,objectFit:'contain',background:'white',borderRadius:10,padding:4,cursor:'pointer',margin:'0 auto',display:'block'}} onClick={()=>onImageClick(dream.qrImage)} />
        </div>
      )}
      <div style={{display:'flex',gap:8,justifyContent:'flex-end',paddingTop:8,borderTop:'1px solid rgba(201,146,74,0.1)'}}>
        <button className="btn btn-outline" style={{fontSize:12,padding:'6px 14px'}} onClick={()=>setEditing(true)}>–ò–∑–º–µ–Ω–∏—Ç—å</button>
        <button style={{fontSize:12,padding:'6px 14px',borderRadius:999,border:'1.5px solid #fca5a5',background:'white',color:'#b91c1c',cursor:'pointer',fontFamily:'Nunito',fontWeight:700}} onClick={handleDelete}>–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>
  );
}

// ===== GUEST: WISH CARD =====
function WishCardGuest({ wish, claim, currentUserName, onClaim, onUnclaim, onImageClick }) {
  const claimed = !!claim;
  const iMine = claim && normalize(claim.claimerName) === normalize(currentUserName);
  const [showTip, setShowTip] = useState(false);
  return (
    <div className="card p-4" style={{display:'flex',flexDirection:'column',gap:10}}>
      {wish.image&&<img src={wish.image} alt="" style={{width:'100%',borderRadius:14,maxHeight:180,objectFit:'cover',cursor:'pointer'}} onClick={()=>onImageClick(wish.image)} />}
      <div style={{display:'flex',alignItems:'flex-start',gap:12}}>
        <div style={{flex:1}}>
          <div style={{fontWeight:700,color:'var(--deep)',fontSize:15}}>{wish.title}</div>
          {wish.note&&<div className="note" style={{marginTop:3}}>{wish.note}</div>}
          {wish.url&&<a href={wish.url} target="_blank" rel="noreferrer" style={{fontSize:12,color:'var(--rose)',textDecoration:'underline',display:'inline-block',marginTop:4}}>–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É</a>}
        </div>
      </div>
      <div style={{paddingTop:8,borderTop:'1px solid rgba(201,146,74,0.1)',display:'flex',justifyContent:'flex-end'}}>
        {claimed ? (iMine ? (
          <div style={{display:'flex',flexDirection:'column',alignItems:'flex-end',gap:6}}>
            <div style={{fontSize:12,fontWeight:700,color:'#92400e',background:'#fefce8',padding:'4px 10px',borderRadius:999}}>üéÅ –í—ã –¥–∞—Ä–∏—Ç–µ —ç—Ç–æ</div>
            <button className="btn btn-outline" style={{fontSize:12,padding:'6px 14px'}} onClick={onUnclaim}>–°–Ω—è—Ç—å –±—Ä–æ–Ω—å</button>
          </div>
        ) : (
          <div style={{position:'relative'}}>
            <div
              style={{fontSize:12,fontWeight:700,color:'#64748b',background:'#e2e8f0',padding:'6px 16px',borderRadius:999,cursor:'default'}}
              onMouseEnter={()=>setShowTip(true)}
              onMouseLeave={()=>setShowTip(false)}
            >–ó–∞–Ω—è—Ç–æ</div>
            {showTip&&<div style={{position:'absolute',right:0,bottom:'calc(100% + 6px)',background:'#1e293b',color:'white',fontSize:11,padding:'5px 10px',borderRadius:8,whiteSpace:'nowrap',zIndex:10}}>üéÅ –î–∞—Ä–∏—Ç: {claim.claimerName}</div>}
          </div>
        )) : (
          <button className="btn btn-primary" style={{fontSize:13,padding:'8px 20px'}} onClick={onClaim}>–Ø –ø–æ–¥–∞—Ä—é üéÅ</button>
        )}
      </div>
    </div>
  );
}

// ===== GUEST: DREAM CARD =====
function DreamCardGuest({ dream, guestName, onImageClick }) {
  const [showContribute, setShowContribute] = useState(false);
  return (
    <>
      <div className="card p-5" style={{display:'flex',flexDirection:'column',gap:12,background:'linear-gradient(135deg,rgba(255,255,255,0.95),rgba(253,246,238,0.95))'}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',gap:10}}>
          <div>
            <div style={{fontWeight:700,color:'var(--deep)',fontSize:16}}>{dream.title}</div>
            {dream.description&&<div className="note" style={{marginTop:4,lineHeight:1.5}}>{dream.description}</div>}
            {dream.link&&<a href={dream.link} target="_blank" rel="noreferrer" style={{fontSize:12,color:'var(--rose)',textDecoration:'underline',display:'inline-block',marginTop:4}}>–ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ –º–µ—á—Ç–µ</a>}
          </div>
          <span className="badge badge-dream" style={{flexShrink:0}}>‚ú® –ú–µ—á—Ç–∞</span>
        </div>

        <div style={{background:'linear-gradient(135deg,rgba(201,146,74,0.1),rgba(232,133,106,0.08))',borderRadius:14,padding:16,textAlign:'center',border:'1px solid rgba(201,146,74,0.2)'}}>
          <div style={{fontFamily:"'Playfair Display',serif",fontSize:13,color:'var(--deep)',marginBottom:4}}>–•–æ—Ç–∏—Ç–µ –≤–ª–æ–∂–∏—Ç—å—Å—è –≤ —ç—Ç—É –º–µ—á—Ç—É?</div>
          <div className="note" style={{fontSize:12,marginBottom:12}}>–ü–æ—Å–ª–µ –ø–µ—Ä–µ–≤–æ–¥–∞ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –∫—Ä–∞—Å–∏–≤—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è –ò—Ä—ã</div>
          <button
            className="btn btn-primary"
            style={{fontSize:13,padding:'9px 24px'}}
            onClick={() => setShowContribute(true)}
          >‚ú® –í–ª–æ–∂–∏—Ç—å—Å—è –∏ –ø–æ–ª—É—á–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç</button>
        </div>
      </div>

      {showContribute && (
        <ContributeModal
          dream={dream}
          guestName={guestName}
          onClose={() => setShowContribute(false)}
        />
      )}
    </>
  );
}

// ===== IMAGE PREVIEW =====
function ImagePreview({ src, onClose }) {
  return (
    <div style={{position:'fixed',inset:0,zIndex:50,background:'rgba(59,42,42,0.75)',backdropFilter:'blur(4px)',display:'flex',alignItems:'center',justifyContent:'center',padding:16}} onClick={onClose}>
      <div style={{position:'relative',maxWidth:'100%',maxHeight:'100%'}} onClick={e=>e.stopPropagation()}>
        <button style={{position:'absolute',top:-12,right:-12,width:30,height:30,borderRadius:'50%',background:'white',border:'none',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',fontSize:14,boxShadow:'0 2px 8px rgba(0,0,0,0.2)',color:'var(--deep)'}} onClick={onClose}>‚úï</button>
        <img src={src} alt="" style={{maxHeight:'85vh',maxWidth:'85vw',borderRadius:18,boxShadow:'0 20px 60px rgba(0,0,0,0.3)',background:'white'}} />
      </div>
    </div>
  );
}

// ===== APP =====
function App() {
  const [authUid,setAuthUid]=useState(null);
  const [userName,setUserName]=useState(loadLocal('ira:name',''));
  const [items,setItems]=useState([]);const [claims,setClaims]=useState({});const [dreams,setDreams]=useState([]);
  const [itemsLoading,setItemsLoading]=useState(true);const [dreamsLoading,setDreamsLoading]=useState(true);
  const [addError,setAddError]=useState('');const [dreamError,setDreamError]=useState('');const [claimError,setClaimError]=useState('');
  const [previewImage,setPreviewImage]=useState(null);

  useEffect(()=>{ const u=auth.onAuthStateChanged(u=>setAuthUid(u?.uid||null)); return u; },[]);
  useEffect(()=>{ saveLocal('ira:name',userName); },[userName]);

  useEffect(()=>{
    setItemsLoading(true);
    const u=itemsCol().orderBy('createdAt','desc').onSnapshot(snap=>{const a=[];snap.forEach(d=>a.push({id:d.id,...d.data()}));setItems(a);setItemsLoading(false);},err=>{console.error(err);setItemsLoading(false);});
    return u;
  },[]);
  useEffect(()=>{
    const u=claimsCol().onSnapshot(snap=>{const m={};snap.forEach(d=>m[d.id]=d.data());setClaims(m);},err=>{console.error(err);setClaims({});});
    return u;
  },[]);
  useEffect(()=>{
    setDreamsLoading(true);
    const u=dreamsCol().orderBy('createdAt','desc').onSnapshot(snap=>{const a=[];snap.forEach(d=>a.push({id:d.id,...d.data()}));setDreams(a);setDreamsLoading(false);},err=>{console.error(err);setDreamsLoading(false);});
    return u;
  },[]);

  const trimmedName = (userName||'').trim();
  const isIra = normalize(trimmedName).startsWith(IRA_KEY);
  const iraWishes = useMemo(()=>items.filter(i=>i.ownerName&&normalize(i.ownerName).startsWith(IRA_KEY)),[items]);
  const iraDreams = useMemo(()=>dreams.filter(d=>d.ownerName&&normalize(d.ownerName).startsWith(IRA_KEY)),[dreams]);

  const handleAddWish = async ({title,url,note,image}) => {
    setAddError('');
    if(!authUid){setAddError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.');return;}
    try{ await itemsCol().add({title,url,note,image:image||null,ownerName:'–ò—Ä–∞',addedByUid:authUid,createdAt:Date.now()}); }
    catch(e){ console.error(e); setAddError('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Firestore Rules.'); }
  };
  const handleUpdateWish = async (id,u) => { try{await itemsCol().doc(id).update(u);}catch(e){console.error(e);setAddError('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å.');} };
  const handleDeleteWish = async id => { try{await itemsCol().doc(id).delete();}catch(e){console.error(e);} };
  const handleAddDream = async ({title,description,link,qrImage}) => {
    setDreamError('');
    if(!authUid){setDreamError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.');return;}
    try{ await dreamsCol().add({title,description,link,qrImage:qrImage||null,ownerName:'–ò—Ä–∞',addedByUid:authUid,createdAt:Date.now()}); }
    catch(e){ console.error(e); setDreamError('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å.'); }
  };
  const handleUpdateDream = async (id,u) => { try{await dreamsCol().doc(id).update(u);}catch(e){console.error(e);} };
  const handleDeleteDream = async id => { try{await dreamsCol().doc(id).delete();}catch(e){console.error(e);} };
  const handleClaim = async wish => {
    setClaimError('');
    if(!trimmedName){setClaimError('–°–Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏—Ç–µ –∏–º—è.');return;}
    const ref=claimsCol().doc(wish.id);
    try{ await db.runTransaction(async tx=>{ const s=await tx.get(ref); if(s.exists)throw new Error('taken'); tx.set(ref,{claimerUid:authUid||null,claimerName:trimmedName,createdAt:Date.now()}); }); }
    catch(e){ console.error(e); setClaimError(e.message==='taken'?'–£–∂–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ.':'–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å.'); }
  };
  const handleUnclaim = async wish => {
    setClaimError('');
    if(!window.confirm('–°–Ω—è—Ç—å –±—Ä–æ–Ω—å?'))return;
    const ref=claimsCol().doc(wish.id);
    try{ await db.runTransaction(async tx=>{ const s=await tx.get(ref); if(!s.exists)throw new Error('none'); const d=s.data(); if((d.claimerUid&&d.claimerUid===authUid)||(!d.claimerUid&&normalize(d.claimerName)===normalize(trimmedName)))tx.delete(ref); else throw new Error('not-owner'); }); }
    catch(e){ console.error(e); setClaimError(e.message==='not-owner'?'–¢–æ–ª—å–∫–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–≤—à–∏–π –º–æ–∂–µ—Ç —Å–Ω—è—Ç—å –±—Ä–æ–Ω—å.':'–ù–µ —É–¥–∞–ª–æ—Å—å —Å–Ω—è—Ç—å –±—Ä–æ–Ω—å.'); }
  };

  return (
    <div style={{paddingBottom:60}}>
      <Header />
      <WhoAreYouCard userName={userName} setUserName={setUserName} />

      {!trimmedName && (
        <div className="container-narrow">
          <p className="note" style={{textAlign:'center'}}>–£–∫–∞–∂–∏—Ç–µ –∏–º—è –≤—ã—à–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–¥–∞—Ä–∫–æ–≤ üéÅ</p>
        </div>
      )}

      {/* IRA MODE */}
      {trimmedName && isIra && (
        <main className="container-narrow" style={{display:'flex',flexDirection:'column',gap:24}}>
          {/* Gifts section */}
          <section>
            <div className="section-title" style={{marginBottom:16}}>–ü–æ–¥–∞—Ä–∫–∏</div>
            <AddWishFormIra onAdd={handleAddWish} disabled={!authUid} error={addError} />
            <div style={{marginBottom:8}}>
              <p className="note">–ì–æ—Å—Ç–∏ –Ω–µ –≤–∏–¥—è—Ç, –∫—Ç–æ —á—Ç–æ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–ª ‚Äî —Å—é—Ä–ø—Ä–∏–∑ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è üéÅ</p>
            </div>
            {iraWishes.length===0&&!itemsLoading&&<p className="note">–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ.</p>}
            <div style={{display:'grid',gap:12,gridTemplateColumns:'repeat(auto-fill,minmax(280px,1fr))'}}>
              {iraWishes.map(w=><WishCardIra key={w.id} wish={w} onDelete={handleDeleteWish} onUpdate={handleUpdateWish} onImageClick={setPreviewImage} />)}
            </div>
          </section>

          {/* Dreams section */}
          <section>
            <div className="section-title" style={{marginBottom:16}}>–ë–æ–ª—å—à–∏–µ –º–µ—á—Ç—ã</div>
            <AddDreamFormIra onAdd={handleAddDream} disabled={!authUid} error={dreamError} />
            <div style={{marginBottom:8}}>
              <p className="note">–ì–æ—Å—Ç–∏ —Å–º–æ–≥—É—Ç –≤–ª–æ–∂–∏—Ç—å—Å—è –≤ –ª—é–±—É—é —Å—É–º–º—É –∏ –ø–æ–ª—É—á–∞—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è –ø–µ—á–∞—Ç–∏ üå∏</p>
            </div>
            {iraDreams.length===0&&!dreamsLoading&&<p className="note">–ü–æ–∫–∞ –±–æ–ª—å—à–∏—Ö –º–µ—á—Ç –Ω–µ—Ç.</p>}
            <div style={{display:'grid',gap:12,gridTemplateColumns:'repeat(auto-fill,minmax(280px,1fr))'}}>
              {iraDreams.map(d=><DreamCardIra key={d.id} dream={d} onDelete={handleDeleteDream} onUpdate={handleUpdateDream} onImageClick={setPreviewImage} />)}
            </div>
          </section>
        </main>
      )}

      {/* GUEST MODE */}
      {trimmedName && !isIra && (
        <main className="container-narrow" style={{display:'flex',flexDirection:'column',gap:28}}>
          {/* Gifts */}
          <section>
            <div className="section-title" style={{marginBottom:12}}>üéÅ –ò–¥–µ–∏ –ø–æ–¥–∞—Ä–∫–æ–≤</div>
            <p className="note" style={{marginBottom:16}}>–í—ã–±–µ—Ä–∏—Ç–µ —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–¥–∞—Ä–∏—Ç—å ‚Äî –¥—Ä—É–≥–∏–µ —É–≤–∏–¥—è—Ç —á—Ç–æ –ø–æ–¥–∞—Ä–æ–∫ –∑–∞–Ω—è—Ç, –∞ –¥–ª—è –ò—Ä—ã —ç—Ç–æ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è —Å—é—Ä–ø—Ä–∏–∑–æ–º!</p>
            {claimError&&<div className="err" style={{marginBottom:10}}>{claimError}</div>}
            {iraWishes.length===0&&!itemsLoading&&<p className="note">–ò—Ä–∞ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–∏–ª–∞ –ø–æ–¥–∞—Ä–∫–∏.</p>}
            <div style={{display:'grid',gap:12,gridTemplateColumns:'repeat(auto-fill,minmax(280px,1fr))'}}>
              {iraWishes.map(w=>(
                <WishCardGuest key={w.id} wish={w} claim={claims[w.id]} currentUserName={trimmedName}
                  onClaim={()=>handleClaim(w)} onUnclaim={()=>handleUnclaim(w)} onImageClick={setPreviewImage} />
              ))}
            </div>
          </section>

          {/* Dreams */}
          <section>
            <div className="section-title" style={{marginBottom:12}}>‚ú® –ë–æ–ª—å—à–∏–µ –º–µ—á—Ç—ã</div>
            <p className="note" style={{marginBottom:16}}>–í–ª–æ–∂–∏—Ç–µ—Å—å –≤ –º–µ—á—Ç—É –Ω–∞ –ª—é–±—É—é —Å—É–º–º—É ‚Äî –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –∫—Ä–∞—Å–∏–≤—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ —Ä–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å –∏ –ø–æ–¥–∞—Ä–∏—Ç—å!</p>
            {iraDreams.length===0&&!dreamsLoading&&<p className="note">–ò—Ä–∞ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–∏–ª–∞ –º–µ—á—Ç—ã.</p>}
            <div style={{display:'grid',gap:12,gridTemplateColumns:'repeat(auto-fill,minmax(300px,1fr))'}}>
              {iraDreams.map(d=>(
                <DreamCardGuest key={d.id} dream={d} guestName={trimmedName} onImageClick={setPreviewImage} />
              ))}
            </div>
          </section>
        </main>
      )}

      {previewImage&&<ImagePreview src={previewImage} onClose={()=>setPreviewImage(null)} />}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);

  </script>
</body>
</html>
