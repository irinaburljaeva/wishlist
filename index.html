<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–°–µ–º–µ–π–Ω—ã–π –≤–∏—à-–ª–∏—Å—Ç</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase (compat –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>

  <style>
    .container-narrow { max-width: 1040px; margin: 0 auto; padding: 0 16px; }
    .card { background:#fff; border:1px solid #e2e8f0; border-radius:16px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .btn { display:inline-flex; align-items:center; justify-content:center; border-radius:12px; padding:10px 14px; font-size:14px; font-weight:600; }
    .btn-primary { background:#0f172a; color:#fff; }
    .btn-ghost { background:transparent; }
    .input, .textarea, .select { width:100%; border:1px solid #cbd5e1; border-radius:12px; padding:8px 12px; outline:none; }
    .input:focus, .textarea:focus, .select:focus { box-shadow: 0 0 0 4px #e2e8f0; }
    .badge { display:inline-flex; align-items:center; gap:6px; border-radius:999px; background:#f1f5f9; color:#334155; font-size:12px; padding:6px 10px; }
    .err { color:#b91c1c; font-size:12px; }
    .note { color:#64748b; font-size:12px; }
  </style>
</head>
<body class="bg-gradient-to-b from-white to-slate-50 min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useState } = React;

    // === Firebase init ===
    const firebaseConfig = {
      apiKey: "AIzaSyC26Xjjr0pFQDVFtCgRyteEpNEjngVOJFI",
      authDomain: "wishlist-37819.firebaseapp.com",
      projectId: "wishlist-37819",
      storageBucket: "wishlist-37819.firebasestorage.app",
      messagingSenderId: "72495355387",
      appId: "1:72495355387:web:0ff709125d3cf33c8c275e"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // –ê–Ω–æ–Ω–∏–º–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    auth.signInAnonymously().catch(console.error);

    // –ö–æ–ª–ª–µ–∫—Ü–∏–∏
    const listDoc   = (listId) => db.collection('lists').doc(listId);
    const itemsCol  = (listId) => listDoc(listId).collection('items');
    const claimsCol = (listId) => listDoc(listId).collection('claims');

    // –£—Ç–∏–ª–∏—Ç—ã
    const saveLocal = (k, v) => localStorage.setItem(k, JSON.stringify(v));
    const loadLocal = (k, fb) => { try { return JSON.parse(localStorage.getItem(k)) ?? fb } catch { return fb } }
    const prettyPrice = (p) => {
      if (!p) return '';
      const num = Number(String(p).replace(/[^0-9.,]/g, '').replace(',', '.'));
      if (Number.isFinite(num)) return new Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD' }).format(num);
      return p;
    };

    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
    function Header({ role, setRole, listId, setListId, displayName, setDisplayName }) {
      return (
        <div className="container-narrow py-6 flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
          <div className="flex items-center gap-3">
            <div className="w-9 h-9 rounded-xl bg-slate-900 text-white flex items-center justify-center">üéÅ</div>
            <div>
              <h1 className="text-2xl font-semibold">–°–µ–º–µ–π–Ω—ã–π –≤–∏—à-–ª–∏—Å—Ç</h1>
              <p className="text-sm text-slate-500">–û–±—â–∏–π —Å–ø–∏—Å–æ–∫ –ø–æ–¥–∞—Ä–∫–æ–≤</p>
            </div>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-4 gap-2 w-full md:w-auto">
            <input className="input md:w-64" value={listId} onChange={e=>setListId(e.target.value.trim())} placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞" />
            <input className="input md:w-44" value={displayName} onChange={e=>setDisplayName(e.target.value)} placeholder="–í–∞—à–µ –∏–º—è" />
            <select className="select md:w-44" value={role} onChange={e=>setRole(e.target.value)}>
              <option value="owner">–ê–≤—Ç–æ—Ä —Å–ø–∏—Å–∫–∞</option>
              <option value="santa">–î–∞—Ä–∏—Ç–µ–ª—å</option>
            </select>
          </div>
        </div>
      );
    }

    function AddItemForm({ onAdd, error }) {
      const [title, setTitle] = useState('');
      const [url, setUrl] = useState('');
      const [price, setPrice] = useState('');
      const [note, setNote] = useState('');

      const submit = () => {
        if (!title.trim()) return;
        onAdd({ title: title.trim(), url: url.trim(), price: price.trim(), note: note.trim() });
        setTitle(''); setUrl(''); setPrice(''); setNote('');
      };

      return (
        <div className="card p-4">
          <div className="grid gap-3 md:grid-cols-3">
            <div className="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-3">
              <input className="input" value={title} onChange={e=>setTitle(e.target.value)} placeholder="–ß—Ç–æ —Ö–æ—á—É" />
              <input className="input" value={price} onChange={e=>setPrice(e.target.value)} placeholder="–¶–µ–Ω–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" />
              <div className="md:col-span-2 flex items-center gap-2">
                <span className="text-slate-500">üîó</span>
                <input className="input" value={url} onChange={e=>setUrl(e.target.value)} placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä" />
              </div>
              <div className="md:col-span-2">
                <textarea className="textarea" rows="3" value={note} onChange={e=>setNote(e.target.value)} placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
              </div>
            </div>
            <div className="flex flex-col gap-2">
              <button className="btn btn-primary w-full" onClick={submit}>‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
              {error && <div className="err">–ù–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∑–∞–ø–∏—Å–∏. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –∞–≤—Ç–æ—Ä —ç—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞.</div>}
              <div className="note">–î–æ–±–∞–≤–ª—è—Ç—å/—É–¥–∞–ª—è—Ç—å –ø–æ–¥–∞—Ä–∫–∏ –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä —Å–ø–∏—Å–∫–∞.</div>
            </div>
          </div>
        </div>
      );
    }

    function ItemCard({ item, role, claimData, onClaim, onUnclaim, onDelete, writeError, isClaimLoading }) {
      const claimed = !!claimData;

      return (
        <div className="card overflow-hidden group">
          <div className="grid grid-cols-[96px_1fr] gap-3 p-3">
            <div className={`w-24 h-24 rounded-xl flex items-center justify-center ${claimed?'bg-green-50':'bg-slate-100'}`}>üéÅ</div>
            <div className="flex flex-col">
              <div className="flex items-start justify-between gap-2">
                <div>
                  <div className="text-base font-semibold leading-tight">{item.title}</div>
                  {item.price && <div className="text-sm text-slate-500">{prettyPrice(item.price)}</div>}
                  {item.note && <div className="text-sm text-slate-500 mt-1 line-clamp-2">{item.note}</div>}
                </div>
                {role === 'owner' && (
                  <button className="btn btn-ghost p-2 opacity-0 group-hover:opacity-100" onClick={()=>onDelete(item.id)} title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                )}
              </div>

              {role === "santa" && (
                <div className="mt-2 flex items-center gap-2 flex-wrap">
                  {item.url && <a href={item.url} target="_blank" rel="noreferrer" className="text-sm underline">–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É</a>}
                  {!claimed && (
                    <button className="btn btn-ghost border border-slate-200" onClick={()=>onClaim(item.id)} disabled={isClaimLoading}>
                      {isClaimLoading ? '–ë—Ä–æ–Ω–∏—Ä—É–µ–º‚Ä¶' : '–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å'}
                    </button>
                  )}
                  {claimed && <span className="badge">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ: {claimData.claimerName}</span>}
                  {writeError && <div className="err w-full">{writeError}</div>}
                </div>
              )}
              {/* –ê–≤—Ç–æ—Ä –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –æ–ø–∏—Å–∞–Ω–∏–µ, –±–µ–∑ —Å—Ç–∞—Ç—É—Å–æ–≤ */}
            </div>
          </div>
        </div>
      );
    }

    function App() {
      const [listId, setListId] = useState(loadLocal('wish:listId', 'newyear2025'));
      const [role, setRole] = useState(loadLocal('wish:role', 'owner'));
      const [displayName, setDisplayName] = useState(loadLocal('wish:name', ''));
      const [items, setItems] = useState([]);
      const [claims, setClaims] = useState({});
      const [writeError, setWriteError] = useState('');
      const [claimLoading, setClaimLoading] = useState(false);

      useEffect(()=>saveLocal('wish:listId', listId), [listId]);
      useEffect(()=>saveLocal('wish:role', role), [role]);
      useEffect(()=>saveLocal('wish:name', displayName), [displayName]);

      // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ items ‚Äî –≤–∏–¥–Ω–æ –≤—Å–µ–º
      useEffect(() => {
        if (!listId) return;
        const unsub = itemsCol(listId)
          .orderBy('createdAt','desc')
          .onSnapshot(snap => setItems(snap.docs.map(d => ({ id: d.id, ...d.data() }))), err => console.error(err));
        return () => unsub && unsub();
      }, [listId]);

      // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ claims ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–∞—Ä–∏—Ç–µ–ª–µ–π
      useEffect(() => {
        if (!listId || role !== "santa") return;
        const unsub = claimsCol(listId).onSnapshot(snap => {
          const obj = {};
          snap.forEach(d => obj[d.id] = d.data());
          setClaims(obj);
        }, err => console.error(err));
        return () => unsub && unsub();
      }, [listId, role]);

      // –í–ê–ñ–ù–û: –ø–æ–º–µ—á–∞–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Å–ø–∏—Å–∫–∞ (ownerUid), –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª —Ä–æ–ª—å "–ê–≤—Ç–æ—Ä"
      useEffect(() => {
        const unsub = auth.onAuthStateChanged(async (user) => {
          if (!user || !listId) return;
          if (role === 'owner') {
            try {
              await listDoc(listId).set(
                { ownerUid: user.uid, updatedAt: Date.now() },
                { merge: true }
              );
            } catch (e) {
              console.error(e);
              setWriteError('–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Å–ø–∏—Å–∫–∞ (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ Firestore).');
            }
          }
        });
        return () => unsub();
      }, [listId, role]);

      // --- –¥–µ–π—Å—Ç–≤–∏—è ---
      const addItem = async ({ title, url, price, note }) => {
        setWriteError('');
        try {
          await itemsCol(listId).add({ title, url, price, note, createdAt: Date.now() });
        } catch (e) {
          console.error(e);
          setWriteError('–ù–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –∞–≤—Ç–æ—Ä —ç—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞.');
        }
      };

      const deleteItem = async (id) => {
        setWriteError('');
        try {
          await itemsCol(listId).doc(id).delete();        // —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º
          await claimsCol(listId).doc(id).delete();       // –æ—á–∏—Å—Ç–∏–º –±—Ä–æ–Ω—å, –µ—Å–ª–∏ –±—ã–ª–∞
        } catch (e) {
          console.error(e);
          setWriteError('–ù–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –∞–≤—Ç–æ—Ä —ç—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞.');
        }
      };

      const claim = async (itemId) => {
        setWriteError('');
        setClaimLoading(true);
        try {
          // –ø—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞: –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å claim, –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º
          const cdoc = await claimsCol(listId).doc(itemId).get();
          if (cdoc.exists) {
            setWriteError('–≠—Ç–æ—Ç –ø–æ–¥–∞—Ä–æ–∫ —É–∂–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–ª–∏.');
          } else {
            await claimsCol(listId).doc(itemId).set({
              claimerName: displayName || '–ë–µ–∑ –∏–º–µ–Ω–∏',
              createdAt: Date.now()
            });
          }
        } catch (e) {
          console.error(e);
          setWriteError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ Firestore).');
        } finally {
          setClaimLoading(false);
        }
      };

      const unclaim = async (itemId) => {
        setWriteError('');
        try {
          await claimsCol(listId).doc(itemId).delete();
        } catch (e) {
          console.error(e);
          setWriteError('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–Ω—è—Ç—å –±—Ä–æ–Ω—å (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ Firestore).');
        }
      };

      return (
        <div>
          <Header role={role} setRole={setRole} listId={listId} setListId={setListId} displayName={displayName} setDisplayName={setDisplayName} />

          <div className="container-narrow space-y-4">
            {role === 'owner' && <AddItemForm onAdd={addItem} error={writeError} />}

            {writeError && role !== 'owner' && <div className="card p-3 err">–û—à–∏–±–∫–∞: {writeError}</div>}

            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
              {items.map(item => (
                <ItemCard
                  key={item.id}
                  item={item}
                  role={role}
                  claimData={claims[item.id]}
                  onClaim={claim}
                  onUnclaim={unclaim}
                  onDelete={role==='owner'?deleteItem:undefined}
                  writeError={writeError}
                  isClaimLoading={claimLoading}
                />
              ))}
            </div>

            {items.length === 0 && (
              <div className="text-center text-slate-500 py-12">
                –ü–æ–∫–∞ –ø—É—Å—Ç–æ. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ –∂–µ–ª–∞–Ω–∏–µ!
              </div>
            )}

            <div className="note container-narrow pb-8">
              <p className="mt-2">
                –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –∞–≤—Ç–æ—Ä —Å–ø–∏—Å–∫–∞ –Ω–µ –≤–∏–¥–∏—Ç —Å—Ç–∞—Ç—É—Å—ã ¬´—Å–≤–æ–±–æ–¥–Ω–æ/–∑–∞–Ω—è—Ç–æ¬ª –∏ –∏–º–µ–Ω–∞. –î–∞—Ä–∏—Ç–µ–ª–∏ –≤–∏–¥—è—Ç –∏ —Å—Ç–∞—Ç—É—Å—ã, –∏ –∏–º–µ–Ω–∞ –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ –±—Ä–æ–Ω–µ–π.
              </p>
              <p>–ù–µ –∑–∞–±—É–¥—å—Ç–µ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ Firestore –∏–∑ —à–∞–≥–∞ 4.</p>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
