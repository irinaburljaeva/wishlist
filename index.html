<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ù–æ–≤–æ–≥–æ–¥–Ω–∏–π —Å–µ–º–µ–π–Ω—ã–π –≤–∏—à-–ª–∏—Å—Ç</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      min-height: 100vh;
      /* —Ñ–æ–Ω –∏–∑ —Ñ–∞–π–ª–∞ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ */
      background-image: url("D1EA6935-8F4B-495D-8B1F-C5BEE102DFE8.png");
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      position: relative;
    }

    /* –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è –≤—É–∞–ª—å –ø–æ–≤–µ—Ä—Ö —Ñ–æ–Ω–∞, —á—Ç–æ–±—ã –≤—Å—ë —á–∏—Ç–∞–ª–æ—Å—å */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.78);
      backdrop-filter: blur(6px);
      z-index: -1;
    }

    .container-narrow { max-width: 960px; margin: 0 auto; padding: 0 16px; }
    .card {
      background:#ffffff;
      border-radius:24px;
      box-shadow:0 20px 40px rgba(15,23,42,.10);
      border:1px solid rgba(148,163,184,.25);
    }
    .btn {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:999px;
      padding:10px 16px;
      font-size:14px;
      font-weight:600;
    }
    .btn-primary {
      background:linear-gradient(135deg,#f97316,#facc15);
      color:#111827;
    }
    .btn-primary:disabled { opacity:.6; cursor:not-allowed; }
    .btn-ghost { background:transparent; color:#0f172a; }
    .btn-tab-active { background:#0f172a; color:#fefce8; }
    .btn-tab-inactive { background:transparent; color:#334155; }

    .input, .textarea {
      width:100%;
      border-radius:16px;
      border:1px solid #e2e8f0;
      padding:10px 14px;
      outline:none;
      background:#f8fafc;
    }
    .input:focus, .textarea:focus {
      border-color:#fb923c;
      box-shadow:0 0 0 3px rgba(251,146,60,.25);
      background:#ffffff;
    }

    .badge {
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius:999px;
      background:#fefce8;
      color:#92400e;
      font-size:11px;
      padding:4px 9px;
    }
    .badge-soft {
      background:#e2e8f0;
      color:#334155;
    }
    .err { color:#b91c1c; font-size:13px; }
    .note { color:#64748b; font-size:13px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useState, useMemo } = React;

    // === Firebase init ===
    const firebaseConfig = {
      apiKey: "AIzaSyC26Xjjr0pFQDVFtCgRyteEpNEjngVOJFI",
      authDomain: "wishlist-37819.firebaseapp.com",
      projectId: "wishlist-37819",
      storageBucket: "wishlist-37819.firebasestorage.app",
      messagingSenderId: "72495355387",
      appId: "1:72495355387:web:0ff709125d3cf33c8c275e"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    auth.signInAnonymously().catch(console.error);

    // –û–¥–∏–Ω –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫ –Ω–∞ –ù–æ–≤—ã–π –≥–æ–¥
    const LIST_ID = 'newyear2025';
    const listDoc  = db.collection('lists').doc(LIST_ID);
    const itemsCol = () => listDoc.collection('items');
    const claimsCol = () => listDoc.collection('claims');

    const saveLocal = (k,v) => localStorage.setItem(k, JSON.stringify(v));
    const loadLocal = (k,fallback) => {
      try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : fallback; }
      catch { return fallback; }
    };

    function Header({ userName }) {
      return (
        <header className="container-narrow pt-6 pb-4">
          <div className="flex items-center gap-4">
            <div className="w-11 h-11 rounded-2xl bg-gradient-to-tr from-rose-500 to-amber-300 flex items-center justify-center text-2xl shadow-lg">
              üéÑ
            </div>
            <div>
              <h1 className="text-2xl font-bold text-slate-900">–ù–æ–≤–æ–≥–æ–¥–Ω–∏–π —Å–µ–º–µ–π–Ω—ã–π –≤–∏—à-–ª–∏—Å—Ç</h1>
              <p className="text-sm text-slate-600">
                {userName ? <>–í—ã: <span className="font-semibold">{userName}</span></> : '–£–∫–∞–∂–∏—Ç–µ —Å–≤–æ—ë –∏–º—è –∏ –¥–æ–±–∞–≤—å—Ç–µ –∂–µ–ª–∞–Ω–∏—è.'}
              </p>
            </div>
          </div>
        </header>
      );
    }

    function NameCard({ userName, setUserName }) {
      return (
        <section className="container-narrow mb-4">
          <div className="card px-5 py-4 flex items-center gap-4">
            <div className="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center text-xl">
              üë§
            </div>
            <div className="flex-1">
              <div className="text-sm font-semibold text-slate-800 mb-1">–®–∞–≥ 1. –ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?</div>
              <input
                className="input text-sm"
                placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò—Ä–∞, –í–∞–ª–µ—Ä–∞, –ú–∞–º–∞‚Ä¶"
                value={userName}
                onChange={e => setUserName(e.target.value)}
              />
              <p className="note mt-1">
                –ò–º—è –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ —Ä—è–¥–æ–º —Å –≤–∞—à–∏–º–∏ –∂–µ–ª–∞–Ω–∏—è–º–∏ –∏ –ø–æ–¥–∞—Ä–∫–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –±—Ä–æ–Ω–∏—Ä—É–µ—Ç–µ.
              </p>
            </div>
          </div>
        </section>
      );
    }

    function Tabs({ activeTab, setActiveTab }) {
      return (
        <div className="container-narrow mb-3">
          <div className="card px-2 py-2 flex gap-2">
            <button
              className={`btn flex-1 text-sm ${activeTab === 'my' ? 'btn-tab-active' : 'btn-tab-inactive'}`}
              onClick={()=>setActiveTab('my')}
            >
              üéÅ –ú–æ–∏ –∂–µ–ª–∞–Ω–∏—è
            </button>
            <button
              className={`btn flex-1 text-sm ${activeTab === 'family' ? 'btn-tab-active' : 'btn-tab-inactive'}`}
              onClick={()=>setActiveTab('family')}
            >
              üéÖ –ü–æ–¥–∞—Ä–∫–∏ —Å–µ–º—å–µ
            </button>
          </div>
        </div>
      );
    }

    // ----- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∂–µ–ª–∞–Ω–∏—è c –∑–∞–≥—Ä—É–∑–∫–æ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -----
    function AddWishForm({ onAdd, disabled, error }) {
      const [title,setTitle] = useState('');
      const [url,setUrl] = useState('');
      const [note,setNote] = useState('');
      const [imageData,setImageData] = useState('');

      const submit = () => {
        if(disabled) return;
        if(!title.trim()) return;
        onAdd({ title:title.trim(), url:url.trim(), note:note.trim(), image:imageData });
        setTitle(''); setUrl(''); setNote(''); setImageData('');
      };

      const handleFileChange = (e) => {
        const file = e.target.files[0];
        if (!file) { setImageData(''); return; }
        const reader = new FileReader();
        reader.onload = () => setImageData(reader.result);
        reader.readAsDataURL(file);
      };

      return (
        <div className="card p-4 mb-4">
          <div className="flex items-center justify-between mb-2">
            <h2 className="font-semibold text-slate-900 text-base">–î–æ–±–∞–≤–∏—Ç—å –∂–µ–ª–∞–Ω–∏–µ</h2>
            <span className="badge text-[11px]">–í–∏–¥—è—Ç –≤—Å–µ, –Ω–æ –±—Ä–æ–Ω–∏ –ø–æ –≤–∞–º –≤—ã –Ω–µ —É–≤–∏–¥–∏—Ç–µ</span>
          </div>
          <div className="space-y-3">
            <input
              className="input text-sm"
              placeholder="–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å? (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç—ë–ø–ª—ã–π –ø–ª–µ–¥)"
              value={title}
              onChange={e=>setTitle(e.target.value)}
            />

            <input
              className="input text-sm"
              placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä (–º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å, —Å–∞–π—Ç‚Ä¶)"
              value={url}
              onChange={e=>setUrl(e.target.value)}
            />

            <textarea
              className="textarea text-sm resize-none"
              rows="2"
              placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: —Ü–≤–µ—Ç, —Ä–∞–∑–º–µ—Ä, –Ω—é–∞–Ω—Å—ã‚Ä¶"
              value={note}
              onChange={e=>setNote(e.target.value)}
            ></textarea>

            <div className="space-y-2">
              <label className="text-sm font-medium text-slate-800">
                –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
              </label>
              <input
                type="file"
                accept="image/*"
                className="input text-sm"
                onChange={handleFileChange}
              />
              {imageData && (
                <img
                  src={imageData}
                  alt="–ü—Ä–µ–≤—å—é –ø–æ–¥–∞—Ä–∫–∞"
                  className="rounded-2xl mt-2 max-h-40 object-cover w-full"
                />
              )}
            </div>

            {error && <div className="err">{error}</div>}
            <div className="flex justify-end">
              <button className="btn btn-primary text-sm" onClick={submit} disabled={disabled}>
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ –º–æ–∏ –∂–µ–ª–∞–Ω–∏—è
              </button>
            </div>
          </div>
        </div>
      );
    }

    function WishCardMy({ wish }) {
      return (
        <div className="card p-3">
          <div className="flex flex-col gap-2">
            {wish.image && (
              <img
                src={wish.image}
                alt=""
                className="w-full rounded-xl object-cover max-h-48"
              />
            )}
            <div className="flex justify-between items-start gap-3">
              <div>
                <div className="font-semibold text-sm text-slate-900">{wish.title}</div>
                {wish.note && <div className="text-xs text-slate-600 mt-1">{wish.note}</div>}
                {wish.url && (
                  <a
                    href={wish.url}
                    target="_blank"
                    rel="noreferrer"
                    className="text-xs text-sky-700 underline mt-1 inline-block"
                  >
                    –û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É
                  </a>
                )}
              </div>
              <span className="badge-soft badge text-[11px]">–ú–æ—ë –∂–µ–ª–∞–Ω–∏–µ</span>
            </div>
          </div>
        </div>
      );
    }

    function WishCardFamily({ wish, claim, onClaim, currentUserName, isMine }) {
      const claimed = !!claim;
      const iGift = claim && claim.claimerName === currentUserName;

      return (
        <div className="card p-3">
          <div className="flex flex-col gap-2">
            {wish.image && (
              <img
                src={wish.image}
                alt=""
                className="w-full rounded-xl object-cover max-h-48"
              />
            )}

            <div className="flex justify-between items-start gap-3">
              <div className="space-y-1">
                <div className="flex items-center gap-2">
                  <div className="font-semibold text-sm text-slate-900">{wish.title}</div>
                </div>
                <div className="flex flex-wrap items-center gap-2">
                  <span className="badge text-[11px]">–î–ª—è: {wish.ownerName || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</span>
                </div>
                {wish.note && <div className="text-xs text-slate-600">{wish.note}</div>}
                {wish.url && (
                  <a
                    href={wish.url}
                    target="_blank"
                    rel="noreferrer"
                    className="text-xs text-sky-700 underline inline-block"
                  >
                    –û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É
                  </a>
                )}
              </div>

              <div className="min-w-[130px] text-right space-y-1">
                {claimed ? (
                  <div className="badge-soft badge w-full justify-end text-[11px]">
                    üéÅ –£–∂–µ –¥–∞—Ä–∏—Ç: {iGift ? '–í—ã' : claim.claimerName}
                  </div>
                ) : (
                  <button
                    className="btn btn-primary text-xs w-full"
                    onClick={onClaim}
                    disabled={isMine}
                  >
                    –Ø –ø–æ–¥–∞—Ä—é
                  </button>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    }

    // ---------- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ----------
    function App() {
      const [authUid,setAuthUid] = useState(null);
      const [userName,setUserName] = useState(loadLocal('nywish:name',''));
      const [activeTab,setActiveTab] = useState('my'); // 'my' | 'family'

      const [items,setItems] = useState([]);
      const [claims,setClaims] = useState({});
      const [itemsLoading,setItemsLoading] = useState(true);
      const [addError,setAddError] = useState('');
      const [claimError,setClaimError] = useState('');

      // auth
      useEffect(() => {
        const unsub = auth.onAuthStateChanged(u => setAuthUid(u?.uid || null));
        return () => unsub();
      }, []);

      // save name
      useEffect(()=>{ saveLocal('nywish:name', userName); }, [userName]);

      // items
      useEffect(() => {
        setItemsLoading(true);
        const unsub = itemsCol().orderBy('createdAt','desc')
          .onSnapshot(
            snap => {
              const arr = [];
              snap.forEach(doc => arr.push({ id: doc.id, ...doc.data() }));
              setItems(arr);
              setItemsLoading(false);
            },
            err => { console.error(err); setItemsLoading(false); }
          );
        return () => unsub();
      }, []);

      // claims
      useEffect(() => {
        if (!authUid) return;
        const unsub = claimsCol().onSnapshot(
          snap => {
            const map = {};
            snap.forEach(doc => map[doc.id] = doc.data());
            setClaims(map);
          },
          err => {
            console.error('claims error', err);
            setClaims({});
          }
        );
        return () => unsub();
      }, [authUid]);

      const myWishes = useMemo(
        () => items.filter(i => i.addedByUid === authUid),
        [items, authUid]
      );
      const familyWishes = useMemo(
        () => items.filter(i => i.addedByUid !== authUid),
        [items, authUid]
      );

      const myGifts = useMemo(() => {
        const ids = Object.entries(claims)
          .filter(([id,c]) => c.claimerUid === authUid)
          .map(([id]) => id);
        return items.filter(i => ids.includes(i.id));
      }, [claims, items, authUid]);

      const handleAddWish = async ({ title, url, note, image }) => {
        setAddError('');
        if (!userName.trim()) {
          setAddError('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ—ë –∏–º—è –Ω–∞–≤–µ—Ä—Ö—É.');
          return;
        }
        try {
          await itemsCol().add({
            title,
            url,
            note,
            image: image || null,
            ownerName: userName.trim(),
            addedByUid: authUid,
            createdAt: Date.now()
          });
        } catch (e) {
          console.error(e);
          setAddError('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Firestore Rules.');
        }
      };

      const handleClaim = async (wish) => {
        setClaimError('');
        if (!userName.trim()) {
          setClaimError('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ—ë –∏–º—è –Ω–∞–≤–µ—Ä—Ö—É.');
          return;
        }
        if (wish.addedByUid === authUid) {
          setClaimError('–ù–µ–ª—å–∑—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –∂–µ–ª–∞–Ω–∏–µ.');
          return;
        }
        try {
          const ref = claimsCol().doc(wish.id);
          const snap = await ref.get();
          if (snap.exists) {
            setClaimError('–≠—Ç–æ—Ç –ø–æ–¥–∞—Ä–æ–∫ —É–∂–µ –∫—Ç–æ-—Ç–æ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–ª.');
            return;
          }
          await ref.set({
            claimerUid: authUid,
            claimerName: userName.trim(),
            createdAt: Date.now()
          });
        } catch (e) {
          console.error(e);
          setClaimError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Firestore Rules.');
        }
      };

      return (
        <div className="pb-10">
          <Header userName={userName} />
          <NameCard userName={userName} setUserName={setUserName} />
          <Tabs activeTab={activeTab} setActiveTab={setActiveTab} />

          <main className="container-narrow space-y-4">
            {activeTab === 'my' && (
              <>
                <AddWishForm onAdd={handleAddWish} disabled={!authUid} error={addError} />
                <section className="space-y-2">
                  <h2 className="text-sm font-semibold text-slate-800 flex items-center gap-2">
                    –ú–æ–∏ –∂–µ–ª–∞–Ω–∏—è
                    {itemsLoading && <span className="note">(–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è‚Ä¶)</span>}
                  </h2>
                  {myWishes.length === 0 && !itemsLoading && (
                    <p className="note">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–æ–¥–∞—Ä–æ–∫, –∫–æ—Ç–æ—Ä—ã–π –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å.</p>
                  )}
                  <div className="grid gap-3 md:grid-cols-2">
                    {myWishes.map(w => <WishCardMy key={w.id} wish={w} />)}
                  </div>
                </section>
              </>
            )}

            {activeTab === 'family' && (
              <>
                <section className="space-y-2">
                  <div className="flex items-center justify-between">
                    <h2 className="text-sm font-semibold text-slate-800 flex itemsheels gap-2">
                      –ñ–µ–ª–∞–Ω–∏—è —Å–µ–º—å–∏
                      {itemsLoading && <span className="note">(–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è‚Ä¶)</span>}
                    </h2>
                  </div>
                  <p className="note">
                    –ó–¥–µ—Å—å –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤–∞—à–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –∂–µ–ª–∞–Ω–∏—è ‚Äî —Ç–æ–ª—å–∫–æ –¥—Ä—É–≥–∏—Ö —á–ª–µ–Ω–æ–≤ —Å–µ–º—å–∏.
                    –í—ã –º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å, –∫–æ–º—É —á—Ç–æ –ø–æ–¥–∞—Ä–∏—Ç—å üíù
                  </p>
                  {claimError && <div className="err">{claimError}</div>}
                  <div className="grid gap-3 md:grid-cols-2">
                    {familyWishes.map(w => (
                      <WishCardFamily
                        key={w.id}
                        wish={w}
                        claim={claims[w.id]}
                        currentUserName={userName.trim()}
                        isMine={w.addedByUid === authUid}
                        onClaim={() => handleClaim(w)}
                      />
                    ))}
                  </div>
                  {familyWishes.length === 0 && !itemsLoading && (
                    <p className="note">–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ, –∫—Ä–æ–º–µ –≤–∞—Å, –Ω–µ –¥–æ–±–∞–≤–∏–ª –∂–µ–ª–∞–Ω–∏–π.</p>
                  )}
                </section>

                {myGifts.length > 0 && (
                  <section className="space-y-1">
                    <h3 className="text-sm font-semibold text-slate-800">–ß—Ç–æ –≤—ã —É–∂–µ –¥–∞—Ä–∏—Ç–µ</h3>
                    <ul className="list-disc list-inside text-xs text-slate-700">
                      {myGifts.map(g => (
                        <li key={g.id}>
                          {g.title} <span className="text-slate-500">–¥–ª—è {g.ownerName || '–±–µ–∑ –∏–º–µ–Ω–∏'}</span>
                        </li>
                      ))}
                    </ul>
                  </section>
                )}
              </>
            )}
          </main>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
